<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.8.7">Jekyll</generator><link href="https://fateev.me/feed.xml" rel="self" type="application/atom+xml" /><link href="https://fateev.me/" rel="alternate" type="text/html" /><updated>2024-11-02T08:27:29-05:00</updated><id>https://fateev.me/feed.xml</id><title type="html">Fateev.me</title><subtitle>Иван Фатеев разработка мобильных приложений</subtitle><entry><title type="html">Испытательный срок для работодателя. Или как понять в какую компанию ты попал?</title><link href="https://fateev.me/ru/probation-period-for-employer.html" rel="alternate" type="text/html" title="Испытательный срок для работодателя. Или как понять в какую компанию ты попал?" /><published>2023-08-04T16:00:00-05:00</published><updated>2023-08-04T16:00:00-05:00</updated><id>https://fateev.me/ru/probation-period-for-employer</id><content type="html" xml:base="https://fateev.me/ru/probation-period-for-employer.html"><![CDATA[<p>Работать в среде, где вам что-то не нравится — чревато выгоранием и другими проблемами.</p>

<p>Несколько простых советов помогут вам определиться с решением.</p>

<h1 id="как-относятся-к-новичкам">Как относятся к новичкам?</h1>

<p>Не зависимо от вашего уровня опыта — после трудоустройства вам должны помочь освоиться. Обычно, на испытательный срок новичкам выделяется куратор. Тот кто будет отвечать на все вопросы по процессам или непосредственно по вашей работе.</p>

<p>Если вас бросили в одиночестве и сказали разбираться самому — это очень плохой знак. Это значит, что работодатель не ценит ни своего, ни вашего времени. Такое может быть, если новички нужны совсем “для галочки”, или “на будущее”.</p>

<p>В нормальных компаниях ценят время, поэтому чем быстрее вы освоитесь, тем для всех лучше.</p>

<p>Хорошим знаком будет, если в первые несколько дней помимо куратора, вам сразу же выдали задачи. Причем эти задачи должны быть средней сложности, чтобы быть по силам новичку, но при этом дать возможность вам проявить себя.</p>

<h1 id="как-относятся-к-обратной-связи">Как относятся к обратной связи?</h1>

<p>Новички — лучший источник обратной связи для компании. Именно новички свежим взглядом обращают внимание на проблемы, которые старожилы не могут заметить.</p>

<p>Во время вашего онбординга вы будете задавать кучу вопросов.</p>

<blockquote>
  <p>“Почему у вас в компании так, а не иначе?”
“Может лучше делать вот так?.”
и т.д.</p>

</blockquote>

<p>В хороших компаниях всегда рады обратной связи. Ее не просто воспринимают, но и обязательно фиксируют, чтобы проработать позже.</p>

<p>Нормальным вариантом так же будет, если в компании есть конкретное мнение по поднятому вопросу, а так же адекватное разъяснение причин, приведших к нему.</p>

<p>Если вам говорят “делай как у нас принято” без подробностей, игнорируют рациональные предложения, то это сигнал больших проблем в компании.</p>

<p>В таком случае можно ожидать, что любые предложения от сотрудников могут игнорироваться.</p>

<p>Хотите ли вы работать в таком месте?</p>

<h1 id="прогрессирует-ли-компания">Прогрессирует ли компания?</h1>

<p>Хуже всего — компании, которые зависли в своей скорлупе и в них годами ничего не меняется. Это связано с предыдущим пунктом. Игнорирование обратной связи ведет к отсутствию прогресса.</p>

<p>Лучше всего спросить своих коллег про то как было в компании год-два назад. Что изменилось? В лучшую ли сторону?</p>

<ul>
  <li>Прогрессирует ли технический стек?</li>
  <li>Следят ли за лучшими практиками в индустрии?</li>
</ul>

<p>Если годами ничего не меняется — это очень тревожный знак. Если коллег, которые так долго работают нет в принципе — еще хуже.</p>

<p>Нормальные компании наблюдают за процессами на постоянной основе, постоянно что-то меняют и оптимизируют. Причем на всех фронтах, как процессуально, так и технологически.</p>

<p>В больших компаниях бывает такое, что они зависают на каком-то определенном неплохом уровне и их это устраивает. Возможно этот уровень подойдет и вам, но нужно понимать, что с годами вряд ли что-то изменится.</p>

<h1 id="есть-ли-планы-на-будущее">Есть ли планы на будущее?</h1>

<p>Из предыдущего пункта вытекает вопрос про планы компании. Если дорожная карта развития отсутствует и компания двигается вслепую — плохой знак.</p>

<p>Хотите ли вы работать в компании, которая возможно загнется через год, потому что у нее нет планов?</p>

<p>Если про планы не рассказывают, и говорят что тебе нужно знать только то, что нужно для твоей работы — плохой знак.</p>

<p>В хороших компаниях — планы транслируются публично и (снова к предыдущим пунктам) рады обратной связи.</p>

<h1 id="может-ли-человек-раскрыть-свой-потенциал">Может ли человек раскрыть свой потенциал?</h1>

<p>Стоит узнать какие есть перспективы развития в вашей роли. Что если вы захотите перейти на роль выше? Что если вы хотите остаться на текущей роли и стать лучше в своей специализации?</p>

<p>Можно узнать у коллег их мнение на этот счет. Давали ли им такую возможность? Были ли повышения? Как используют сильные стороны людей?</p>

<p>В хороших компаниях — людям помогают расти, а не ставят палки в колеса.</p>]]></content><author><name>Ivan Fateev</name></author><category term="Career" /><category term="Career" /><summary type="html"><![CDATA[Принято считать, что испытательный срок — для сотрудников. Вы приходите на новую работу и чувствуете себя не в своей тарелке, ведь вы пока не уверены, что справитесь со своей работой. А если уверены — то вам нужно это доказать. Но важно понимать, что ближайшие пару месяцев можно и нужно использовать, чтобы понять подходит ли работодатель вам?]]></summary></entry><entry><title type="html">Startup challenges: Lost bugs, anxiety and burnout</title><link href="https://fateev.me/en/startup-challenges/ensuring-the-quality-appium.html" rel="alternate" type="text/html" title="Startup challenges: Lost bugs, anxiety and burnout" /><published>2022-04-22T16:00:00-05:00</published><updated>2022-04-22T16:00:00-05:00</updated><id>https://fateev.me/en/startup-challenges/startup-challenges-bug-tracking</id><content type="html" xml:base="https://fateev.me/en/startup-challenges/ensuring-the-quality-appium.html"><![CDATA[<h2 id="first-heres-the-solution-that-worked-for-us-tl-dr">First, here’s the solution that worked for us (TL; DR;)</h2>

<ol>
  <li>Start by creating a doc on the QA process</li>
  <li>Split the process of registering bugs and fixing them</li>
  <li>Create a dedicated role for registering bug reports</li>
  <li>Assign duty schedule for the role</li>
  <li>Start registering ALL of the bugs in the task tracker, even if engineers are unhappy with it</li>
  <li>Each bug should be assigned a priority depending on the criticality level</li>
  <li>Track metrics with your task tracker</li>
</ol>

<h2 id="reasons-to-change-the-process">Reasons to change the process</h2>

<p>We’ve run a performance review that uncovered a bunch of issues in our development processes.</p>

<p>The major issue raised by devs was the inability to stay in the flow due to constant distractions on bug reports.</p>

<p>They had to change focus during the feature development to identify the bug, its priority, etc. There was no specific duty process, so people dealt with the bugs sporadically.</p>

<p>As a result, devs said they were in a constant anxiety state. The feeling that something is wrong with the product. The urge to fix it instantly as the bug arrives.</p>

<p>The planned release date also slipped due to these issues.</p>

<p>And devs didn’t feel right to tell the team they were working on the bugs instead of the feature.</p>

<h2 id="a-doc-on-the-qa-process">A doc on the QA process</h2>

<p>We didn’t have any doc on how to handle bug reports. People did it differently. Creating a doc and keeping it up-to-date helped to align the process between teams and people. Everybody acts the same. Not to mention people onboarding now goes much faster.</p>

<h2 id="split-the-process-of-registering-bugs-and-fixing-them">Split the process of registering bugs and fixing them</h2>

<p>QA department in mature companies usually keeps track of all bug reports by registering them in a task tracking system. In our startup, we believe the devs own the quality of their outcome, so the responsibility to track bugs is on them.</p>

<p>We didn’t have the former process documented. Devs usually started fixing the bug as soon as they had time for that.</p>

<p>Devs spent much time fixing minor issues while critical stuff awaited in the queue.</p>

<p>We split the former process into two phases. The first one is to register the bug in the task tracker. The second one is the fixing itself.</p>

<p>The most important part of the registration process is assigning bug priority. If it’s not critical, a developer puts the bug into the queue.</p>

<p>A developer should fix critical bugs ASAP.</p>

<p>On the next planning iteration, devs get bugs from the queue to fix according to priority. They plan what bug to fix in the current iteration, considering the workload.</p>

<p>Everybody’s now happy to know that they can reduce distractions on bug reports and plan their work.</p>

<h2 id="create-a-dedicated-role-for-registering-bug-reports">Create a dedicated role for registering bug reports</h2>

<p>In our company, we call it “Bug Hunter.” Devs are wearing the hat of this role. But in any other company, it can be, for instance, QA.</p>

<p>Having a dedicated person dealing with bug reports keep others focused on their job. They don’t feel anxiety anymore since they know somebody is on duty.</p>

<h2 id="assign-duty-schedule-for-the-role">Assign duty schedule for the role</h2>

<p>The duty schedule is really important. We let people self-organize to decide who’s on duty. But the general recommendations are:</p>

<ul>
  <li>make sure the team passes the torch since nobody wants to be the “Bug Hunter” forever</li>
  <li>for mobile devs, it’s enough to check bug reports one or two times a day. The possibility of missing the critical bug is quite low. Besides mobile app release cycle is pretty slow. The person wearing the “Bug Hunter” hat is not 100% consumed by that role, so it’s possible to do other tasks as well</li>
  <li>organize the process of passing the context between the last duty person and the current one. It can be some unfinished tasks, actions, etc.</li>
</ul>

<h2 id="start-registering-all-of-the-bugs-in-the-task-tracker-even-if-engineers-are-unhappy-with-it">Start registering ALL of the bugs in the task tracker, even if engineers are unhappy with it</h2>

<p>Unless you have all bugs registered, you have no idea how good or bad your product quality is.</p>

<p>Having the broader picture helps to make the right decisions. For example, you can have a lot of minor bugs and a few critical ones. It’s reasonable to start fixing critical ones first.</p>

<p>The other insight might be discovering a cluster of bugs. For example, having a bunch of bugs in the authorization module might mean there’s a technical debt to pay. It’s better to plan a refactoring instead of applying minor patches.</p>

<p>We asked our devs to choose the “Bug Hunter” and start registering all the problems they observe in the task tracker. We provided the template for bug tickets to unify and simplify the process.</p>

<p>At first, our devs were not happy about it. But after a month, they saw the benefit. They identified parts of the system needing more attention and care and adjusted plans for technical improvements accordingly.</p>

<p>By bounding all PRs to tickets, we’ve got another benefit. Besides the standard commit message, git blame could tell you the complete story. <strong>The test case</strong> of the problem, <strong>expected result</strong> and <strong>actual result</strong> before the fix.</p>

<h2 id="each-bug-should-be-assigned-a-priority-depending-on-the-criticality-level">Each bug should be assigned a priority depending on the criticality level</h2>

<p>The next challenge is to deal with the growing queue of bugs. We’ve adopted the standard way of prioritizing issues via the matrix, where the X-axis is the bug severity, Y-axis is the number of users affected. The resulting value is the ticket’s priority. W/F stands for “Won’t fix”</p>

<p><img src="/assets/images/bug-prioritization-matrix.png" alt="Bug prioritization matrix" /></p>

<p>The matrix is easily adjustable for the company’s needs.</p>

<p>Our bug severities are:</p>

<ol>
  <li>The security issue</li>
  <li>
    <p>Problem with onboarding where CX can’t help manually and requires effort from devs (otherwise it should be severity 7).</p>

    <p>The bug affects a primary feature. But only if (all of below true):</p>

    <ul>
      <li>a bug appeared in recent releases</li>
      <li>customer have no alternative ways to do the action or can’t be sorted out by the Customer Support team and devs (otherwise it should be Severity 7)</li>
    </ul>

    <p><strong>If it was in prod for a long time</strong> (a few weeks or more), then it should be Severity 3</p>
  </li>
  <li>The “Severity 2” bug existing in prod for a long time (a few weeks or more)  but has been discovered recently</li>
  <li>Application crash</li>
  <li>The client cannot perform secondary functions (all but severity 2), but the Customer Support  team or devs can’t help resolve it manually, or there is no alternative way to do it (otherwise it should be Severity 7)</li>
  <li>UI is not correct, or UX problem</li>
  <li>There’s a bug not covered by previous severities, but the Customer Support team can resolve it manually or with little to no effort from devs</li>
  <li>The speed of the application suffers</li>
  <li>The application does not support phone model</li>
</ol>

<h2 id="track-metrics-with-your-task-tracker">Track metrics with your task tracker</h2>

<p>In our task tracker, we use tags to assign a priority. Each month we look at the report and see the trends. For example, you should expect the high-priority bugs queue to be processed faster than others.</p>

<p>We didn’t set any concrete numbers as a target metric for the team. Instead, we expect a declining trend in the bugs queue.</p>]]></content><author><name>Ivan Fateev</name></author><category term="Processes" /><category term="Management" /><category term="Processes" /><summary type="html"><![CDATA[Bugs in your company get lost in the chat, users leave, management blames engineers, engineers feel guilty and anxious, get burned out? We've been there. Here's what we learned.]]></summary></entry><entry><title type="html">Startup challenges: Ensuring the quality with Appium</title><link href="https://fateev.me/en/startup-challenges/ensuring-the-quality-appium.html" rel="alternate" type="text/html" title="Startup challenges: Ensuring the quality with Appium" /><published>2021-05-11T16:00:00-05:00</published><updated>2021-05-11T16:00:00-05:00</updated><id>https://fateev.me/en/startup-challenges/appium</id><content type="html" xml:base="https://fateev.me/en/startup-challenges/ensuring-the-quality-appium.html"><![CDATA[<p>Our backend team writes <a href="https://www.geeksforgeeks.org/agile-testing-methods-behavior-driven-testing/">Behavior Driven Tests</a> with <a href="https://behave.readthedocs.io/en/stable/">Behave</a> to check their integration with external clients.</p>

<p>But since these tests can only emulate external clients (like mobile apps), they didn’t check end-to-end integration.</p>

<p>We thought that having an honest end-to-end check will guarantee the correctness of the basic product scenarios.</p>

<p><a href="https://appium.io">Appium</a> is easy to set up and use. We piloted it in conjunction with <a href="https://saucelabs.com">Sauce Labs</a> for launching and recording test results.</p>

<p>We assumed that any team/role (backend dev, mobile dev, QA engineer, etc.) could use a universal tool like Appium. We hoped the backend team would primarily use them as they are familiar with the Python language.</p>

<h2 id="experiment-results">Experiment results</h2>

<p>We integrated Appium tests into CI/CD pipelines of the backend and mobile apps. We piloted the solution for half a year. Through this time, it caught few major bugs.</p>

<h3 id="tests-writing-experience">Tests writing experience</h3>

<p>After setting up some test infrastructure, they were easy to write.</p>

<p>Here’s the excerpt from one of the tests:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">PreviewAndShareScreen</span><span class="p">(</span><span class="n">CloseableScreen</span><span class="p">):</span>
    <span class="n">share_button</span><span class="p">:</span> <span class="n">TestObject</span>

    <span class="k">def</span> <span class="nf">assert_has_share_button</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">wait_for</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">share_button</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">share</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">is_ios</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">wait_and_click</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">share_button</span><span class="p">)</span>

    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">App</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">app</span><span class="p">.</span><span class="n">is_ios</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PreviewAndShareScreen</span><span class="p">(</span>
                <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span>
                <span class="n">share_button</span><span class="o">=</span><span class="n">ios_button_by_text</span><span class="p">(</span><span class="s">'Share'</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">PreviewAndShareScreen</span><span class="p">(</span>
            <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span>
            <span class="n">share_button</span><span class="o">=</span><span class="n">obj_by_text_and_id</span><span class="p">(</span><span class="s">'Share'</span><span class="p">,</span> <span class="s">'com.anna.money.app.dev:id/buttonPrimary'</span><span class="p">)</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">TestAccountStatement</span><span class="p">:</span>
    <span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">mark</span><span class="p">.</span><span class="n">regress</span>
    <span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">mark</span><span class="p">.</span><span class="n">statement</span>
    <span class="k">def</span> <span class="nf">test_account_statement_share</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">registered_user_app</span><span class="p">:</span> <span class="n">App</span><span class="p">):</span>
        <span class="n">preview_screen</span> <span class="o">=</span> <span class="n">PreviewAndShareScreen</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">registered_user_app</span><span class="p">)</span>
        <span class="n">system_popups</span> <span class="o">=</span> <span class="n">SystemPopups</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">registered_user_app</span><span class="p">)</span>
        <span class="n">chat_screen</span> <span class="o">=</span> <span class="n">ChatScreen</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">registered_user_app</span><span class="p">)</span>

        <span class="c1"># wait for suggest to appear
</span>        <span class="n">chat_screen</span><span class="p">.</span><span class="n">get_suggest</span><span class="p">(</span><span class="s">'Create an invoice'</span><span class="p">)</span>
        <span class="n">chat_screen</span><span class="p">.</span><span class="n">send_text</span><span class="p">(</span><span class="s">'Account statement'</span><span class="p">)</span>
        <span class="n">chat_screen</span><span class="p">.</span><span class="n">click_suggest</span><span class="p">(</span><span class="s">'Full history'</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">check_sharing</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">registered_user_app</span><span class="p">.</span><span class="n">is_ios</span><span class="p">:</span>
                <span class="n">preview_screen</span><span class="p">.</span><span class="n">assert_has_share_button</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">preview_screen</span><span class="p">.</span><span class="n">share</span><span class="p">()</span>
                <span class="n">system_popups</span><span class="p">.</span><span class="n">wait_for_share_popup</span><span class="p">()</span>
                <span class="c1"># cancel native share popup
</span>                <span class="n">system_popups</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>

            <span class="n">preview_screen</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># check PDF
</span>        <span class="n">account_statement_card</span> <span class="o">=</span> <span class="n">T5</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">registered_user_app</span><span class="p">)</span>
        <span class="n">account_statement_card</span><span class="p">.</span><span class="n">click_second_button</span><span class="p">(</span><span class="s">'PDF'</span><span class="p">)</span>

        <span class="n">check_sharing</span><span class="p">()</span>

        <span class="c1"># check CSV
</span>
        <span class="n">account_statement_card</span><span class="p">.</span><span class="n">click_first_button</span><span class="p">(</span><span class="s">'CSV'</span><span class="p">)</span>
        <span class="n">check_sharing</span><span class="p">()</span>
</code></pre></div></div>

<p>As you can see, it required platform-specific queries. So it could take quite a while to write a new test completely since you need to check it on Android and iOS separately.</p>

<h3 id="false-positive-results">False-positive results</h3>

<p>Since our backend utilizes a microservice architecture, it has a lot of moving parts. It means every time this and that may get broken. It resulted in unstable test results.</p>

<p>Though we provided quite convenient tools to track down the problem, it was quite hard to find the source of the problem. Most of the time, the tests were false-positive. It made Appium tests noisy. After some time, everybody lost attention to the alerts.</p>

<h3 id="no-integration-in-the-process">No integration in the process</h3>

<p>We failed to integrate Appium tests in the development processes of teams.</p>

<p>The Backend team was more familiar with Behave, so they didn’t see a lot of benefit in using Appium. They were not ready to invest more time in Appium infrastructure, as they were fine with Behave tests.</p>

<h2 id="summary">Summary</h2>

<p>Since we didn’t get much interest in this tool from developers, we decided to close the experiment.</p>

<p>Teams are more effective with platform-specific tools, like Behave, XCTest, Espresso, etc.</p>]]></content><author><name>Ivan Fateev</name></author><category term="Programming" /><category term="Programming" /><summary type="html"><![CDATA[One of the main challenges in our startup is to ensure that our product is of good quality. We decided to try Appium to test end-to-end scenarios.]]></summary></entry><entry><title type="html">How to clean a legacy code: stop complaining, start doing</title><link href="https://fateev.me/en/programming/how-to-clean-a-legacy-code-stop-complaining-start-doing.html" rel="alternate" type="text/html" title="How to clean a legacy code: stop complaining, start doing" /><published>2021-01-14T15:00:00-06:00</published><updated>2021-01-14T15:00:00-06:00</updated><id>https://fateev.me/en/programming/how-to-clean-a-legacy-code-stop-complaining-start-doing</id><content type="html" xml:base="https://fateev.me/en/programming/how-to-clean-a-legacy-code-stop-complaining-start-doing.html"><![CDATA[<h2 id="blue-or-red-pill">Blue or Red pill?</h2>

<p>When it happens to join a project with a poor codebase, usually you have two options:</p>

<ol>
  <li>Complain about the code</li>
  <li>Search for another job</li>
  <li>Start doing everything right</li>
</ol>

<p>The first two options are easy and crystal clear. But the last one is not so simple.</p>

<p>I was in the same situation a bunch of times, and always chose the last one. And here what worked for me:</p>

<ol>
  <li>Plan changes</li>
  <li>Isolate legacy</li>
  <li>Lead by example</li>
  <li>Teach</li>
  <li>Scale</li>
  <li>Clean the shit in small and quick iterations</li>
  <li>Document the code as you refactor</li>
  <li>Write tests</li>
</ol>

<p>Now, before getting into more details, let’s think a bit.</p>

<h2 id="why-does-this-happen">Why does this happen?</h2>

<p>The poor state of the codebase is a result of previously made decisions. It’s hard to tell if they were right or wrong. But the point is that “clean code” is not always a good option for business.</p>

<p>Nobody expects you to write a clean and neat code for a prototype. You should make the prototype as fast as you can, check your hypothesis, and throw it away.</p>

<p>Yes, some people CAN write code fast and clean, but it’s hard to find them. And startups, for example, do not have time and money for that.</p>

<p>As the company grows, priorities change, and businesses need larger teams, more features etc. It’s impossible to continue in a paradigm where speed is the only priority.</p>

<p>So, being an experienced developer, you likely may find yourself in a project which was written by less experienced people. And that’s fine.</p>

<p>My point is that complaining and blaming people for being dumb is not professional.</p>

<p>Now, let’s move to the points of healing the project in more details</p>

<h2 id="plan-changes">Plan changes</h2>

<p>All changes for the good should start with a plan. Usually I identify what needs to be improved, break it down for tasks, roughly estimate them, and also assess benefits this task can bring to the codebase in a 5-star scale.</p>

<p>Then I prioritize a backlog by the highest benefit and the smallest size.</p>

<h2 id="isolate-legacy">Isolate legacy</h2>

<p>To start refactoring without blocking feature development, you need to commit changes in small chunks and predictable deadlines.</p>

<p>One of the handiest ways to run smooth ongoing refactoring in huge and dynamic projects is to isolate legacy parts.</p>

<p>This means before rebuilding all of the “legacy” internals, you need to hide them behind a “clean” abstraction layer.</p>

<p>So you have to have a clear vision of the architecture you want to get to. Then you need to build that “clean” abstraction interface and put it before the “legacy” part. So all the code users will see only a new, clean interface, and already may start building a better code.</p>

<p>It’s done with the help of the “Adapter” pattern.</p>

<p>Meanwhile, the legacy part may be ugly, but the adapter connects it to the clean world.</p>

<p>Once it’s done, you can start reworking the legacy code. Since the legacy code is isolated, your changes won’t affect anybody else. It literally unties your hands.</p>

<h2 id="lead-by-example">Lead by example</h2>

<p>It might be helpful to lead changes by example. This means you need to show your teammates how changes may be executed. It’s absolutely unnecessary to have a “Lead” position to do this.</p>

<p>Not everybody will agree with changes, but if you did your planning well, it should be easy to “sell” them.</p>

<p>The next possible step might be selling these changes to your manager, or whoever decides what team should be working on.</p>

<p>After you’re done with it, you might start with actual leading by example.</p>

<p>You need to take the first task from the backlog, and do it as you see it. It will be an example of how people can take steps towards a bright future.</p>

<p>The “Lead by example” strategy helped me a bunch of times where other strategies failed. Being skeptical for a programmer is pretty normal. But when you do not only say that it’s possible to make things better, you actually DO it, and do it well, people start changing their minds.</p>

<p>They see that you’ve managed to do this, and it means that they can do it too. You gain trust, and future changes will go smoother.</p>

<h2 id="teach">Teach</h2>

<p>The “Lead by example” strategy is also a good opportunity to teach people. You can walk through your teammates over your solution and ideas, and show them improvements using Before/After contrast.</p>

<p>People always understand concepts better, having real-world examples rather than some abstract philosophic statements.</p>

<p>Make people feel comfortable to ask questions, share ideas, etc.</p>

<h2 id="scale">Scale</h2>

<p>Once you proved that your plan is good, and you’re on the same page with the team, it’s time to scale it out.</p>

<p>Recruit more team members to help you out. Guide them through this process. After a few iterations, everybody will see fruits of labor and be happy to help more.</p>

<h2 id="clean-the-code-in-small-and-quick-iterations">Clean the code in small and quick iterations</h2>

<p>It should not be necessary to say why you would need to execute refactoring in small iterations, but yet.</p>

<ol>
  <li>Large refactoring is hard to review</li>
  <li>If large refactoring got declined by the team, a lot of manhours be wasted. Doing small iterations is much less risky</li>
  <li>More you spend time on refactoring, the more complex merge will be for you and your teammates. You might find yourself solving conflicts over and over, and something will likely break</li>
  <li>We are bad at estimations, so if a refactoring slips the deadline, you might likely be forced to cancel it</li>
  <li>Focused changes are always easier to deliver</li>
  <li>Small changes have fewer risks to break something and are easier to test</li>
  <li>Never mix the code refactoring with the feature development. You will have a huge mess in this case. You won’t be able to release a feature without finishing refactoring before it, or rollback refactoring separately.</li>
</ol>

<p>Focus is the most important part. It’s so easy to deep dive in the shit, and start cleaning it from the bottom.</p>

<p>But you should force yourself to stop and limit the scope only to what’s is relevant for the current iteration.</p>

<p>If you do, the team will be happy to work that way, and eventually, you’ll get to the final point.</p>

<p>If you don’t, well… massive refactoring won’t be finished at all, or it will break too many things.</p>

<h2 id="document-the-code-as-you-refactor">Document the code as you refactor</h2>

<p>Refactoring is also a good opportunity to clarify things. I rarely see a documented code, but often find myself questioning parts of the code, as it’s hard to tell what this code is doing and why.</p>

<p>If you managed to find out business requirements or some details about it, document it! This will help you or anybody else who will get back to this part later.</p>

<p>Also, it’s helpful to document your thoughts on your vision on the refactoring approach.</p>

<p>For example, I add code comments advising what can be done next to improve this or that part, and how to do it better. So if my colleagues stumble on it, they understand how to move forward.</p>

<h2 id="write-tests">Write tests</h2>

<p>You’re lucky if the subject of the refactoring has any tests at all. But most likely it’s not.</p>

<p>Ideally, before refactoring, you should write tests, to make sure, that after refactoring behavior remained the same.</p>

<p>But we’re not in the ideal world. Often there’s no test infrastructure at all.</p>

<p>Here what I usually do:</p>

<ol>
  <li>Provide testability for the new “clean” code first.</li>
  <li>Test all of the new features which should be clean.</li>
  <li>Then you can start bringing testability to the legacy code, step by step, small chunks, remember?</li>
</ol>

<h2 id="any-decent-programmer-should-be-able-to-do-both-at-the-same-time">Any decent programmer should be able to do both at the same time</h2>

<p>Though this is true, and I didn’t say that the one shouldn’t, but I personally, find it a bad idea, if the refactoring is not tiny. In this article I meant huge refactoring activities, which can’t be done in a single day and by a single person.</p>

<p>The point of the article is just to show a structured and predictable way of cleaning up the code, that everybody can understand.</p>

<p>As a programmer, you see what needs to be done, a pool of tasks. As a manager, you understand that refactoring can be mixed into the daily work, and you won’t be spending development resources for weeks with no visible result.</p>

<h2 id="final-thoughts">Final thoughts</h2>

<p>Reworking a legacy code is a tough and long task. But it’s possible. It’s easy to say that we need to rewrite everything from scratch. But structured and planned refactoring is a much better way.</p>

<p>Refactoring has a cumulative effect. With each iteration, it will be easier and easier to work with the code. So be the leader, take the hardest steps, show how this can be done.</p>

<p>–</p>

<p>What works for me, might not work for you, but still, I believe you might give it a try.</p>]]></content><author><name>Ivan Fateev</name></author><category term="Programming" /><category term="Programming" /><category term="Management" /><summary type="html"><![CDATA[Most of the articles and books tell you how to write a "good code". But in real life, you often find yourself deep in the shit after joining some company or project.]]></summary></entry><entry><title type="html">Правильно ли вы растите своих джунов?</title><link href="https://fateev.me/ru/programming/are-you-growing-your-juniors-right.html" rel="alternate" type="text/html" title="Правильно ли вы растите своих джунов?" /><published>2020-04-03T16:00:00-05:00</published><updated>2020-04-03T16:00:00-05:00</updated><id>https://fateev.me/ru/programming/are-you-growing-your-juniors-right</id><content type="html" xml:base="https://fateev.me/ru/programming/are-you-growing-your-juniors-right.html"><![CDATA[<p>А ничего! Буквально – ничего! В том то и дело.</p>

<p>Когда мой ученик рассказал о том, что происходит у него на работе, я не смог больше терпеть, и решился на эту статью. Вдруг получится помочь хоть нескольким людям.</p>

<p>Рассмотрим пару проблем. Подобные ситуации возникают не только в нашей индустрии. Вы их можете найти в любом месте, где нанимают стажеров/новичков.</p>

<h2 id="проблема-1-джуном-никто-не-занимается">Проблема №1: Джуном никто не занимается</h2>

<p>Джун до этого работал в другой сфере, и на этот свитч карьеры решался долго. Он учился в свободное от работы время. Потом поставил на кон все, уволился со старой работы и несколько месяцев продолжал учиться нон-стоп, существуя на накопленные средства. И наконец-то получил свою первую работу программистом с окладом, значительно меньшим, чем у него был до этого.</p>

<p>В течение года <del>наставники</del> кураторы Джуна постоянно менялись. Его тупо перекидывали от одного к другому, никто не хотел им заниматься.</p>

<p>Никаких внятных задач ему не давали. Скидывали какое-то непонятное говно, с которым никто не хотел возиться.</p>

<p>Потом и говнозадачи кончились. Сказали сиди там читай что-нибудь, развивайся сам.</p>

<p>Затем ему дали разбираться с продуктом, который ну очень специфический. Опыт работы с ним практически никак не котируется на рынке труда. При этом, ни у кого другого не было ни опыта ни желания заниматься такой фигней. То есть Джуну даже не к кому было обратиться за помощью.</p>

<p>Это было первое место работы в качестве программиста, и оценить, нормальна такая ситуация или нет – он не мог. Джун боялся, что если не разберется, то его уволят. Вся эта история психологически угнетала, было ощущение, что время уходит зря, а он бессилен что-либо сделать.</p>

<p>Он поделился этим со мной, и я рекомендовал сменить место работы. Что он и сделал.</p>

<h2 id="проблема-2-джуном-занимается-тот-кто-не-умеет-учить-или-не-хочет-этим-заниматься">Проблема №2: Джуном занимается тот, кто не умеет учить, или не хочет этим заниматься</h2>

<p>На новом месте работы джуну понравилось больше. Там назначили конкретного ментора, который ставил нормальные задачи, следил за их исполнением, немножко учил. Джун начал прокачиваться.</p>

<p>Спустя пару месяцев, иногда ментор начинал вести себя странно. В такие моменты появлялось ощущение какой-то личной неприязни, или что-то вроде того.</p>

<p>Просто посмотрите на пример диалога ниже.</p>

<ul>
  <li>Джун: М, на счёт задачи XXX-413, Вы написали “Переделать: отображение диалога реализовать в классе действия RestoreDbAction” - я что-то не понял, в каком смысле “реализовать”? я сейчас сделал так, что вызывается RestoreDbAction.Confirm вместо IDialogDisplay.Show, но всё остальное получается оставляю как было, или я чего-то не понял?</li>
  <li>Ментор: До тебя долго доходит. Понял наконец?</li>
  <li>Джун: … я сейчас всё правильно понял?</li>
  <li>Ментор: Что?</li>
  <li>Джун: просто надо было использовать Confirm от Action?</li>
  <li>Ментор: Конечно</li>
  <li>Ментор: Почему сразу не догадался? Ещё вопросы?</li>
</ul>

<hr />

<ul>
  <li>Ментор: Как я и думал, Д, ты опять ничего не понял. Я просто удивляюсь твоей несообразительности….. (sad) Задачу вернул на доработку</li>
  <li>Джун: я же спрашивал, правильно ли я понял</li>
  <li>Ментор: я тоже спрашивал. 3 раза. И все равно ты понял неправильно</li>
</ul>

<h2 id="зачем-компании-джуны">Зачем компании джуны?</h2>

<p>Давайте разберемся, в чем смысл растить джунов?</p>

<p>Джун – это вклад в будущее. Долгосрочный проект, если хотите.</p>

<p>Компания дает знания и опыт, а начинающий специалист со временем начинает возвращать инвестиции в виде выполненных задач. Получается такой выгодный симбиоз.</p>

<p>Джун с огоньком в глазах готов писать код просто потому, что это интересно и прикольно. А если за это еще и деньги платят — тем более.</p>

<p>Чем быстрее Джун начнет выполнять реальные задачи, приносить пользу, тем выгоднее это для компании.</p>

<p class="notice--info">Стартапы редко берут джунов. Ведь им нужно, чтобы отдача от разработчика была моментальной. Для стартапа, главное – скорость. Большие компании – другое дело. Они могут позволить себе не спешить.</p>

<p>Для работодателя существует две веских причины растить джунов:</p>

<ol>
  <li><strong>Дешевая рабочая сила</strong>: они не просят много денег. А если джуна прокачали быстро, то за малые деньги компания получит неплохого специалиста, заточенного именно под ее процессы.</li>
  <li>
    <p><strong>Предсказуемый источник хороших кадров</strong>.
Найм – всегда гемор. Поиск миддла может занять много времени и сил.
Даже если кандидат идеально прошел собеседование, предсказать как он покажет себя в работе – невозможно. В случае ошибки компания терпит убытки.</p>

    <p>Вместо этого можно нанять пачку джунов. И вероятность найти подходящий кадр выше. Хороший работодатель заметит джунов, выросших в уровне, даст повышение и стимулирует развитие дальше.</p>

    <p>При этом компания получает нового прокачанного разраба, с известной производительностью, знакомого с процессами и так далее. Ситуация win-win.</p>

    <p>Если такой формат поставлен на поток, то компания может довольно стабильно расти.</p>
  </li>
</ol>

<h2 id="несколько-простых-советов-по-воспитанию-джунов">Несколько простых советов по воспитанию джунов</h2>
<h3 id="1-не-берите-джунов-если-ими-некому-заниматься">1. Не берите джунов, если ими некому заниматься</h3>

<p>Что можно извлечь из описания проблемы №1? Компания наняла джуна, но при этом им никто нормально не занимался. Он хотел учиться, и цеплялся за любую возможность.</p>

<p>Но работодателю было явно не до младших разрабов. Джун просто сидел на окладе, не принося компании выгоды, и не прокачивался сам. Ситуация lose-lose.</p>

<p>Джуны требуют постоянного надзора. Они как дети, которые пробуют ходить. Вначале у них это совсем не получается, но с каждым разом справляются все лучше. Однажды они начинают довольно уверено ходить и почти не требуют присмотра.</p>

<p>Что будет с ребенком, если его оставить одного? Наверняка случится что-то плохое. Поранится, уползет куда-нибудь не туда, что-нибудь сломает. Так случилось и в описанном случае.</p>

<p>Начальный этап взращивания джуна — самый сложный. Он требует приличных затрат времени и моральных сил. Нужно понимать, что тот, кто менторит – будет работать медленнее. Но в долгосрочной перспективе все окупится.</p>

<p>Если вы не готовы пойти на такие затраты, то не надо брать джунов. Не тратьте ресурсы компании зря, уважайте время людей.</p>

<p>С проблемой №1 покончено. Перейдем к проблеме №2.</p>

<h3 id="2-не-надо-перекладывать-ответственность">2. Не надо перекладывать ответственность</h3>

<p>В диалоге из проблемы №2 не прав именно ментор. Джун недостаточно квалифицирован, чтобы формализовать задачу, выяснить недостающие требования, спроектировать хорошее решение и так далее.</p>

<p>То, что Джун неправильно понял задачу – полностью вина ментора. Но он, вместо того, чтобы исправить положение, сложил вину с себя.</p>

<h3 id="3-ставьте-джуну-максимально-подробные-задачи">3. Ставьте Джуну максимально подробные задачи</h3>

<p>Задача ментора максимально подробно разжевать задачу. Можно подтолкнуть в правильном направлении, но не нужно из этого устраивать шоу “Интуиция”. От этого никто не выиграет. Со временем Джун сам научится задавать правильные вопросы.</p>

<p>Решение задачи не нужно рассказывать сразу, но постановка должна быть достаточно подробной, чтобы не было вероятности неправильной трактовки.</p>

<p>Если есть сомнения, еще раз поговорите с Джуном и убедитесь, что вы поняли друг друга верно. И да, лучше разговаривать голосом, а не в чате. Это сильно помогает.</p>

<h3 id="4-не-надо-самоутверждаться-за-счет-других">4. Не надо самоутверждаться за счет других</h3>

<p>Уффф, тут мое брюзжание будет долгим, потому что от таких примеров бомбит у меня знатно.</p>

<p>В приведенном диалоге ментор повел себя с Джуном очень грубо и непрофессионально. Я могу предположить следующее:</p>

<ol>
  <li>У ментора личная неприязнь к Джуну. По одному диалогу сложно судить, но Джун сказал, что у него было именно такое ощущение в нескольких эпизодах. Стоит говорить о том, что это категорически неприемлемо?</li>
  <li>Ментор не хочет заниматься менторством. Как бы глупо это не звучало. Не все хотят этим заниматься. Компания должна следить за тем, кто натаскивает джунов. Если человеку не нравится такой род деятельности, ничего хорошего из этого не выйдет.</li>
  <li>
    <p>У ментора трудности со своими задачами, а тут еще джун. Как бы тебе ни было трудно, не нужно переносить свои проблемы, эмоции на других. Как минимум – это непрофессионально, а просто по-человечески – это свинство.</p>

    <p>Руководство должно понимать, что работа с джунами отнимает много времени, и делать на это скидку при формировании нагрузки ментора.</p>
  </li>
  <li>
    <p>Ментору не дано учить. Хороший разработчик – не обязательно хороший учитель. Уметь подобрать правильные слова – многого стоит.</p>

    <p>На какой результат рассчитывал ментор? Что Джун подумает, “Ой какой я несообразительный, буду над этим работать”?</p>

    <p>Такие слова могут отбить всякую мотивацию напрочь. Могут зародить сомнения в себе, и потом люди рассказывают про синдром самозванца. Могут просто отбить желание задавать вопросы и общаться с коллегами, потому что будет страшно. Но самое плохое, человек, который поставил на кон все, может просто опустить руки и отказаться от своей мечты.</p>

    <p>Ничего, кроме тупого самоутверждения “ты – дурак, а я – звезда” тут нет.</p>

    <p>Все мы были в начале пути. Вспомните, как с вами разговаривали коллеги? Поддерживали ли вас? Что вы чувствовали?</p>
  </li>
</ol>

<p>Ни один из приведенных вариантов не может служить оправданием такого тона. Нельзя так разговаривать с вашими подчиненными, коллегами. Самоутверждаться и унижать других, пользуясь своим положением. Ни у кого нет такого права.</p>

<p>Если бы ментор так разговаривал с профессионалом своего уровня, то разговор получился бы совершенно другим. Новичок же все проглотит, будет держать в себе. Ни к чему хорошему это не приведет.</p>

<h3 id="5-давайте-джунам-не-только-рутинные-задачи">5. Давайте Джунам не только рутинные задачи</h3>

<p>На одной рутине не прокачаешься. Да, простые задачи удобно скинуть с себя. Но не нужно воспринимать новичка, как своего раба. Джуну нужно тренировать мышление. Ему нужны сложные испытания.</p>

<p>Постарайтесь разбавлять скучную работу чем-нибудь интересным. Помните, то что для вас скучно, для новичка может быть впервой. Главное, чтобы задачи были разнообразными. Обучение будет проходить гораздо бодрее.</p>

<h3 id="6-давайте-не-только-негативную-обратную-связь">6. Давайте не только негативную обратную связь</h3>

<p>Помните, кроме кнута есть еще и пряник. Не бывает универсального подхода для всех людей. Но все любят, когда их искренне хвалят. Такое поощрение может быть великим стимулом.</p>

<p>Начинающие менторы частенько концентрируют внимание только на ошибках, но совершенно не отмечают то, в чем новичок проявил себя хорошо.</p>

<p>Все хорошо в меру, поэтому между кнутом и пряником должен быть баланс.</p>

<h3 id="7-давайте-совершать-ошибки">7. Давайте совершать ошибки</h3>

<p>Именно благодаря ошибкам мы учимся. Когда Джун оспаривает ваши слова, не нужно воспринимать это на свой счет. Если вы злитесь – в вас играет ваше эго.</p>

<p>Если говорить “делай вот так”, но не объяснять почему – новичок ничему не научится.</p>

<p>Уберите ваше самолюбие подальше. Дайте новичку проверить свою гипотезу, идею. Затем уже предметно, объективно, спокойно покажите в чем именно ошибка и как можно было бы сделать лучше.</p>

<p>Джун сравнит до/после, поразмыслит над аргументами и сделает выводы. Вот увидите, при таком подходе он будет расти гораздо быстрее.</p>

<hr />

<p>Подведем итог. Воспитание джуна – непростое дело. Руководство должно учитывать, что это будет требовать много времени и распределять нагрузку на менторов соответственно. Это должно быть частью процессов компании.</p>

<p>Не все способны учить. Назначайте менторами тех, кто этого хочет, и кто способен на это.</p>

<p>Джуны – тоже люди. Они очень неуверены в себе. Не нужно пользоваться своим статусом и культивировать в них комплексы. Наоборот, вспомните себя и окажите нужную поддержку новичкам.</p>

<p>Найм джунов будет выгоден для компании только если этот процесс будет проходить быстро и эффективно. Общение с джунами отличается от общения с коллегами вашего уровня. Это нужно учитывать и следовать советам, которые я описал.</p>

<p>Если у вас в компании есть человек, подходящий на роль ментора, дайте ему возможность. Оно однозначного того стоит.</p>]]></content><author><name>Ivan Fateev</name></author><category term="Programming" /><category term="Programming" /><category term="Soft skills" /><category term="Management" /><summary type="html"><![CDATA[У меня есть ученик. В начале его пути я помогал ему постичь наше ремесло, потом он попал в одну крупную компанию. Что с ним там сделали, вы не поверите...]]></summary></entry><entry><title type="html">Are you growing your juniors right?</title><link href="https://fateev.me/en/programming/are-you-growing-your-juniors-right.html" rel="alternate" type="text/html" title="Are you growing your juniors right?" /><published>2020-04-03T16:00:00-05:00</published><updated>2020-04-03T16:00:00-05:00</updated><id>https://fateev.me/en/programming/are-you-growing-your-juniors-right.en</id><content type="html" xml:base="https://fateev.me/en/programming/are-you-growing-your-juniors-right.html"><![CDATA[<p>Nothing! Literally – nothing. And that’s the point.</p>

<p>When my student told me about what’s happening in his job, I couldn’t take it anymore and decided to write this article. I hope to help at least some people with it.</p>

<p>Let’s look at a couple of problems. Such situations happen not only in our industry. You can find them in any place where they hire interns/beginners.</p>

<h2 id="problem-1-nobody-cares-about-junior">Problem #1: Nobody cares about junior</h2>

<p>Junior worked in a different industry before. It took a long time to decide on a career switch. He learned programming in his spare time. Then he put all stakes on it, quit his old job, and spent several months learning non-stop, living on saved money. Finally, he’s got a new job as an intern programmer, but with a salary much less than he had before.</p>

<p>During the year Junior’s <del>mentors</del> curators changed all the time. They dumbly threw him from one to another, nobody wanted to take care of him.</p>

<p>They didn’t give any meaningful task. Just dumped on him some weird shit, which nobody wanted to deal with.</p>

<p>Later even those shitty tasks came to an end. They said to him to sit and read something, learn yourself.</p>

<p>Then they let him work with some “specific” product. You know, this kind of corporate product which has a really tiny niche. Such experience means nothing on the job market. Nobody else had either desire or experience with it. So he couldn’t even ask anybody to help out.</p>

<p>It was a first programmer job for him, so he couldn’t evaluate whether such a situation is normal or not. Junior was afraid that if he couldn’t figure out something, they would fire him. It depressed him, he had a feeling that he’s wasting time, but there’s nothing to do about that.</p>

<p>He shared it with me, and I recommended to change the job. And he did it.</p>

<h2 id="problem-2-junior-is-trained-by-someone-whos-not-able-to-teach-or-dont-want-to-do-that">Problem #2: Junior is trained by someone who’s not able to teach, or don’t want to do that</h2>

<p>Junior liked the new job. They assigned a specific mentor, which gave appropriate tasks, kept an eye on their status, taught a bit. Junior started to improve his skills.</p>

<p>A couple of months later, the mentor started to behave strangely. In such moments there was a feeling of some personal dislike from his side.</p>

<p>Just look at the dialog below:</p>

<ul>
  <li>Junior: Mentor, in regards of the task XXX-413, you said: “Change: implement dialog presentation in class RestoreDbAction” - I didn’t get it, What do you mean by “implement”? Now I just made that it calls RestoreDbAction.Confirm instead of IDialogDisplay.Show. Everything else I leave as is, am I right or I missed something?</li>
  <li>Mentor: It took so long for you to understand. Got it finally?</li>
  <li>Junior: … so I got it right?</li>
  <li>Mentor: What?</li>
  <li>Junior: I needed to use Action.Confirm?</li>
  <li>Mentor: Of course</li>
  <li>Mentor: Why didn’t you get it right away? Any questions??</li>
</ul>

<hr />

<ul>
  <li>Mentor: Just as I expected, Junior, you didn’t get ANYTHING again. I’m just surprised at how you’re slow-witted….. (sad) I returned the task back to you</li>
  <li>Junior: But I asked if I got it right</li>
  <li>Mentor: I also asked. 3 times. And you didn’t get it anyway</li>
</ul>

<h2 id="why-a-company-needs-juniors">Why a company needs juniors?</h2>

<p>Let’s see what’s the point in growing juniors?</p>

<p>Junior is an investment in the future. Long-term project if you want.</p>

<p>The company gives knowledge and experience, and beginner specialist starts returning investments in the form of completed tasks. So it’s like an effective symbiosis.</p>

<p>Junior is ready to write code just for fun. But if you pay money for it – just perfect.</p>

<p>Faster Junior starts completing real tasks, bring value, more profitable it would be for a company.</p>

<p class="notice--info">Startups rarely hire juniors. Because they need an instant result. For a startup, speed is the most important aspect. Large companies are different. They can afford a slower pace.</p>

<p>There are two big points to hire juniors:</p>

<ol>
  <li><strong>Cheap workforce</strong>: they do not ask much. And if you trained your junior quickly, then you get a fair specialist which brings value, familiar with the company’s processes, and does not cost much.</li>
  <li>
    <p><strong>Predictable source of advanced specialists</strong>.
Hiring is always a pain. Searching for a middle developer can take quite a time and effort. Even if you managed to get one through the interview, you can’t predict how he will show himself. In case of a mistake, the company suffers losses.</p>

    <p>You can hire a bunch of juniors instead. In this case, the probability to find a good fit is much higher. Good employer spots juniors which grew enough, give them a raise and motivate for further growth.</p>

    <p>So the company gets a new grown developer, with known performance, familiar with processes, and so on. It’s a win-win situation.</p>

    <p>If such an approach is arranged in a proper pipeline, then the company can grow safely and stably.</p>
  </li>
</ol>

<h2 id="a-bunch-of-simple-tips-on-growing-a-junior">A bunch of simple tips on growing a Junior</h2>
<h3 id="1-do-not-hire-juniors-if-nobody-can-teach-them">1. Do not hire juniors if nobody can teach them</h3>

<p>What can we understand from problem #1? The company hired a junior, though nobody could (or want) to teach him. He wanted to learn. Chased any opportunity to do that.</p>

<p>But the employer didn’t care about beginner developers. Our Junior didn’t bring any value to the company, didn’t grow as professional, yet got his salary. It’s a lose-lose situation.</p>

<p>Juniors need constant attention and supervision. They are like children who are learning to walk. At first, they are clumsy, can’t take a step. But every time they get better in it. One day they walk on their own, confidently.</p>

<p>What could happen if you left them alone, while they’re learning? Something bad will likely happen. They could get hurt, crawl somewhere they shouldn’t, even break something. And this is exactly what we have in problem #1.</p>

<p>The first stage of junior’s training is the toughest one. It requires a lot of time, emotional efforts, and patience. A company needs to understand, the one who mentors will work slower. But in the long term, it will pay off.</p>

<p>If you’re not ready for such cost, you should not hire juniors. Don’t waste the company’s resources and people’s time. Please.</p>

<p>That’s it with problem #1, let’s move on to problem #2.</p>

<h3 id="2-dont-pass-the-buck">2. Don’t pass the buck</h3>

<p>In dialog from the problem #2 mentor is the one who’s not right. Junior is not qualified enough to formalize a task, find out missing requirements, design a decent solution, etc.</p>

<p>The mentor is the only one to blame that junior didn’t get the task right. But instead of fixing this situation he just passed the buck.</p>

<h3 id="3-for-juniors-you-should-assign-tasks-which-are-detailed-as-much-as-possible">3. For juniors, you should assign tasks which are detailed as much as possible</h3>

<p>Mentor has to detail tasks as much as possible. Alternatively, if you want a junior to think more, you can just give a clue of the right direction. But you shouldn’t make an “Intuition” show out of it.</p>

<p>It’s not necessary to give a task solution right away, but the task description should be detailed enough, to exclude any ambiguity.</p>

<p>If you have any doubts, talk with Junior again and make sure, that you both are on the same page. And one more thing: you should talk, not write in the chat. It helps a lot!</p>

<h3 id="4-do-not-assert-yourself-by-hurting-others">4. Do not assert yourself by hurting others</h3>

<p>Oh, my rant is going to be long for this one. Because such examples give me a butthurt.</p>

<p>In the dialog above mentor was really rude and unprofessional with Junior. I can guess that:</p>

<ol>
  <li>The mentor has a personal dislike for Junior. It’s hard to tell from just one dialog, but Junior said that he had exactly such a feeling. Should I say that it’s absolutely unacceptable?</li>
  <li>The mentor doesn’t want to do mentoring. It might sound silly, but not everyone wants to do that. A company should keep an eye on who’s training juniors. If some person doesn’t like such a job, nothing good can get out of it.</li>
  <li>The mentor is having a hard time doing his own tasks, not to speak of the junior. No matter how difficult it is, you should not transfer your problems, feelings to others. It’s unprofessional at least, but, just humanly, it’s disgusting. Management has to understand that mentoring takes a lot of time and plan accordingly, allocating a fixed buffer of time in the mentor’s schedule.</li>
  <li>The mentor just can’t teach. A good developer – not necessarily a good teacher. Choosing the right words is worth a lot. What result did the mentor expect? That Junior will think “Oh, what a retard I am, I will work on it”? Such words may discourage, raise doubts. Then people complain about impostor syndrome. Words can kill any desire to ask questions and talk with teammates, because of fear. But the worst part is that a person who put everything on a table may turn around and lose everything. There’s nothing except dumb assertion “you’re stupid, I’m a star”. We’ve all been newbies. Remember how did your colleagues treat you? Did they support you? How did you feel?</li>
</ol>

<p>None of the options may be an excuse for such a tone of voice. It’s totally unacceptable to talk that way with your subordinates, colleagues. Assert and humiliate others, taking advantage of your position. Nobody has such rights.</p>

<p>If the mentor would use such a tone of voice with a professional of the same level or higher, the conversation would be absolutely different. But newbie closes his eyes on it. He just keeps all the feelings inside. It won’t lead to anything good.</p>

<h3 id="5-give-your-juniors-not-only-routine-tasks">5. Give your Juniors not only routine tasks</h3>

<p>You can’t improve your skills just by doing the same tasks over and over again. Yes, it’s very convenient to pass boring tasks to someone else. But you shouldn’t treat newbies as your slaves. Junior has to train thinking. He needs challenges.</p>

<p>Try to mix in interesting tasks to routine. Remember, things which are boring to you, might be something new for junior. It’s important to keep tasks diverse. Education will go faster that way.</p>

<h3 id="6-give-not-only-negative-feedback">6. Give not only negative feedback</h3>

<p>Remember, there are two tools. Often people miss the second one: positive feedback. Though there’s no universal approach for every person. But usually, everybody likes to get praise. And it can be a great stimulus.</p>

<p>Mentors who are just started to train people often focus attention on mistakes only. And never say or point out where newbie was good at.</p>

<p>Everything should be in balance. Feedback should be objective and balanced as well.</p>

<h3 id="7-let-them-make-mistakes">7. Let them make mistakes</h3>

<p>We learn because of mistakes. When Junior argues with you, you shouldn’t take it personally. If you feel annoyed – it’s your ego.</p>

<p>You shouldn’t just say “Do like this”, without any explanation why – newbie won’t learning anything from that.</p>

<p>Shut your ego down somewhere. Let newbie check his hypothesis or idea. Then he’ll have a perfect example to learn from. You can go through every mistake and objectively tell what exactly was wrong, why, and how to do it right.</p>

<p>Junior will compare “before” and “after”, make conclusions. You’ll see how faster they grow with such an approach.</p>

<hr />

<p>Let’s wrap it up.</p>

<p>Education – is not an easy task. Management should take into account that it will consume a lot of your mentor’s time, thus workload should be adjusted accordingly. It should be a part of a company’s processes.</p>

<p>Not everyone can teach. Assign a mentor role only to those who want it and who’s able to.</p>

<p>Juniors are also humans. They are so unconfident. You should not take advantage of your status and cultivate complexes in them. Remember yourself in their place and give all support their need.</p>

<p>The hiring of juniors is beneficial only if the education process goes fast and effective. Interaction and communication with juniors is different than with colleagues of your level. You should keep it in mind and follow the tips.</p>

<p>If you have a person in your company that fits the role of a mentor, give him or her an opportunity. It’s definitely worth it.</p>]]></content><author><name>Ivan Fateev</name></author><category term="Programming" /><category term="Programming" /><category term="Soft skills" /><category term="Management" /><summary type="html"><![CDATA[I have a student. At the beginning of his path, I helped him to comprehend our craft. Then he got into a quite big company. What they did to him...]]></summary></entry><entry><title type="html">Независимый UI слой — ускоряем разработку UI</title><link href="https://fateev.me/ru/gamedev/independent-ui-layer.html" rel="alternate" type="text/html" title="Независимый UI слой — ускоряем разработку UI" /><published>2018-11-15T15:00:00-06:00</published><updated>2018-11-15T15:00:00-06:00</updated><id>https://fateev.me/ru/gamedev/independent-ui-layer</id><content type="html" xml:base="https://fateev.me/ru/gamedev/independent-ui-layer.html"><![CDATA[<p>Это первая статья из цикла “Ускоряем разработку UI”. В этом цикле я хочу поднять проблему, которая у нас остро стояла на нескольких проектах. Одной из главных головных болей в повседневной разработке у нас частенько были UI задачи:</p>

<ol>
  <li>UI, как правило, пишется не изолировано, поэтому протестировать его, например, на отдельной сцене, может быть проблематично</li>
  <li>Дизайнеры креативят то, что сложно впихнуть в игру: постоянная борьба за размер текстур, сложность реализации тех или иных компонентов и т.д.</li>
  <li>Нет дизайн гайдбука, где описаны все цвета, элементы и т.д. Многие вещи делаются на глаз, что порождает большое количество итераций по правкам дизайнера в стиле “тут на два пикселя больше, а тут цвет не тот”.</li>
  <li>Из предыдущего пункта выливается отсутствие стандартных элементов, переиспользуемых в UI. Одинаковые вещи делаются разными людьми, привнося разные баги.</li>
</ol>

<p>Это только то что, что сразу пришло на ум. Конечно же, со всем этим можно, и нужно разбираться.</p>

<h2 id="изолированное-тестирование-ui">Изолированное тестирование UI</h2>

<p>Один из сложнейших случаев тестирования: есть какой-либо игровой ивент, завязанный на сервер, ограниченный временными рамками, и работающий только при определенном количестве игроков.</p>

<p>Чтобы проверить поведение UI в таких сложно-воспроизводимых условиях, зачастую пишутся хаки/тулы и т.д., чтобы их обеспечить. Это может и работает, но требует все равно приличных усилий на поддержку, и много телодвижений при использовании.</p>

<p>Очень ломает со всем этим заморачиваться, когда нужно проверить что-нибудь тривиально, например, действительно ли появляется спиннер, если мы кликнем на кнопку в UI ивента.</p>

<p>Мы, разработчики, очень ленивые люди. Нередки ситуации, когда кто-то шлепнет фикс не глядя, авось прокатит, а тестер потом нам сообщит если что не так. Если таких итераций несколько, то это огромная трата времени, как разработчика, так и отдела тестирования.</p>

<p>Чтобы убрать издержки на тестирование в таких ситуациях, нужно обеспечить легкий способ проверять правки. Как правило, большинство UI элементов имеют всего-лишь несколько состояний, которые довольно просто проверять изолировано.</p>

<p><img src="/imgs/ui-arch.png" alt="Изображение, где есть три слоя: UI, бизнес логика и сервер" /></p>

<p>К сожалению, я редко вижу практику, когда UI элементы изолируют от остального кода. UI кишит привязками к синглтонам, моделям, которые не имеют никакого отношения к UI, системным сервисам, аналитике, и так далее. А это ведет нас к истокам проблемы.</p>

<p>Различные шаблоны UI не просто так придумали. Но почему то считается, что к разработке игр, в частности на Unity, они не особенно применимы. Лично я убедился, что это не так.</p>

<p>Это типичная архитектура UI. Я тут не привязывался к конкретному паттерну, это может быть MVP/MVC/MVVM, не суть. Во всех шаблонах есть четкое разделение на слои. Если это разделение отсутствует, то тестировать UI изолированно не выйдет.</p>

<p>Ключевые моменты, на которые стоит обратить внимание:</p>
<ul>
  <li>У бизнес логики и UI <strong>разные модели</strong>. Это позволяет использовать одни и те же компоненты UI в привязке к разным частям бизнес логики. Плюс вы всегда можете, например, перетащить такой UI в другой проект, или даже организовать репозиторий с общими компонентами.</li>
  <li>View Script максимально тупой. Он либо передает пользовательский ввод в слой бизнес логики, либо реагирует на обновление view model со стороны бизнес логики.
_ Изменение моделей однонаправленное, вьюха напрямую не меняет модели. Это упрощает понимание и отладку логики.</li>
  <li>Добавьте RX и получится неплохой микс</li>
</ul>

<p>Не смотря на то, что такое разделение может показаться избыточным, на практике – это очень удобно.</p>

<ul>
  <li>UI складывается из различных компонентов, которые можно переиспользовать, комбинировать совершенно независимо.</li>
  <li>Тестировать конкретный компонент UI можно вытащив на отдельную сцену, ведь нет завязки на какие-либо компоненты и модели бизнес-логики</li>
  <li>Если хорошенько поработать на тулами, встроить их в редактор, то интерфейсы строить сможет даже дизайнер</li>
  <li>Если UI скрипты скрыта за интерфейсами, то <strong>бизнес логику можно тестировать независимо от UI</strong>, юнит тестами.</li>
  <li>Работу над UI и бизнес-логикой можно вести <strong>параллельно</strong>, обговорив контракт, в виде интерфейсов</li>
</ul>

<h2 id="немного-кода">Немного кода</h2>

<p>Я решил в качестве примера накидать простенькое окно, которое может быть в трех состояниях:</p>

<ul>
  <li>Загрузка</li>
  <li>Ошибка</li>
  <li>Отображение контента</li>
</ul>

<p>Для простоты, контент – строки.</p>

<p>Префаб окна выглядит примерно так:</p>

<p><img src="/imgs/loadable-window-prefab.png" alt="префаб окна на сцене" /></p>

<p>Обычно дизайн UI я начинаю с модели для конкретного компонента. Для начала обозначим три взаимоисключающих состояния окна.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">enum</span> <span class="n">LoadableWindowState</span>
<span class="p">{</span>
	<span class="n">READY</span><span class="p">,</span>
	<span class="n">LOADING</span><span class="p">,</span>
	<span class="n">ERROR</span>
<span class="p">}</span></code></pre></figure>

<p>Далее определимся какие данные нужны для отображения в окне, и зафиксируем их в контракте-интерфейсе:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">interface</span> <span class="nc">ILoadableWindowViewModel</span>
<span class="p">{</span>
	<span class="n">IObservable</span><span class="p">&lt;</span><span class="n">LoadableWindowState</span><span class="p">&gt;</span> <span class="n">state</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
	<span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">content</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
	<span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">error</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
	<span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">buttonTitle</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

	<span class="k">void</span> <span class="nf">ButtonClicked</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>Сформировав уже на этом этапе контракт, разработка UI и бизнес логики могла бы происходить параллельно.</p>

<p>В некоторых случаях интерфейс для модели может быть избыточным. Но я нахожу интерфейсы более гибкими, так как они позволяют отвязаться от наследования.</p>

<p>Тогда моделью может выступать любой класс, например, сам презентер/контроллер. Было бы невозможно его одновременно унаследовать и от базового класса, и от модели.</p>

<p>Дефолтная имплементация модели пригодится для теста, при желании ее можно использоват и в бизнес логике.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">LoadableWindowViewModel</span> <span class="p">:</span> <span class="n">ILoadableWindowViewModel</span>
<span class="p">{</span>
	<span class="k">public</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="n">LoadableWindowState</span><span class="p">&gt;</span> <span class="n">state</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">stateSubject</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
	<span class="k">public</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">content</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">contentSubject</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
	<span class="k">public</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">error</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">errorSubject</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
	<span class="k">public</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">buttonTitle</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">buttonTitleSubject</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>

	<span class="k">public</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="n">buttonClicked</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_buttonClicked</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>

	<span class="k">public</span> <span class="k">void</span> <span class="nf">ButtonClicked</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="n">_buttonClicked</span><span class="p">.</span><span class="nf">OnNext</span><span class="p">(</span><span class="n">Unit</span><span class="p">.</span><span class="n">Default</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">public</span> <span class="k">readonly</span> <span class="n">BehaviorSubject</span><span class="p">&lt;</span><span class="n">LoadableWindowState</span><span class="p">&gt;</span> <span class="n">stateSubject</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BehaviorSubject</span><span class="p">&lt;</span><span class="n">LoadableWindowState</span><span class="p">&gt;(</span><span class="n">LoadableWindowState</span><span class="p">.</span><span class="n">LOADING</span><span class="p">);</span>
	<span class="k">public</span> <span class="k">readonly</span> <span class="n">BehaviorSubject</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">contentSubject</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BehaviorSubject</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">);</span>
	<span class="k">public</span> <span class="k">readonly</span> <span class="n">BehaviorSubject</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">errorSubject</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BehaviorSubject</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">);</span>
	<span class="k">public</span> <span class="k">readonly</span> <span class="n">BehaviorSubject</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">buttonTitleSubject</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BehaviorSubject</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">);</span>

	<span class="k">private</span> <span class="n">Subject</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="n">_buttonClicked</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Subject</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;();</span>

<span class="p">}</span></code></pre></figure>

<p>Реализация самого окна сводится просто к байндингам:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">LoadableWindow</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>

	<span class="k">public</span> <span class="n">Button</span> <span class="n">button</span><span class="p">;</span>
	<span class="k">public</span> <span class="n">Text</span> <span class="n">buttonText</span><span class="p">;</span>
	<span class="k">public</span> <span class="n">Text</span> <span class="n">errorText</span><span class="p">;</span>
	<span class="k">public</span> <span class="n">Text</span> <span class="n">content</span><span class="p">;</span>
	<span class="k">public</span> <span class="n">RectTransform</span> <span class="n">spinner</span><span class="p">;</span>

	<span class="k">private</span> <span class="n">IDisposable</span> <span class="n">_viewModelSubscription</span><span class="p">;</span>

	<span class="k">public</span> <span class="k">void</span> <span class="nf">init</span><span class="p">(</span><span class="n">ILoadableWindowViewModel</span> <span class="n">model</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">var</span> <span class="n">disposable</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CompositeDisposable</span><span class="p">();</span>
		<span class="n">model</span><span class="p">.</span><span class="n">buttonTitle</span><span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">buttonText</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">s</span><span class="p">).</span><span class="nf">AddTo</span><span class="p">(</span><span class="n">disposable</span><span class="p">);</span>
		<span class="n">model</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">errorText</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">s</span><span class="p">).</span><span class="nf">AddTo</span><span class="p">(</span><span class="n">disposable</span><span class="p">);</span>
		<span class="n">model</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">content</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">s</span><span class="p">).</span><span class="nf">AddTo</span><span class="p">(</span><span class="n">disposable</span><span class="p">);</span>
		<span class="n">model</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span>
		<span class="p">{</span>
			<span class="n">spinner</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="nf">SetActive</span><span class="p">(</span><span class="n">s</span> <span class="p">==</span> <span class="n">LoadableWindowState</span><span class="p">.</span><span class="n">LOADING</span><span class="p">);</span>
			<span class="n">content</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="nf">SetActive</span><span class="p">(</span><span class="n">s</span> <span class="p">==</span> <span class="n">LoadableWindowState</span><span class="p">.</span><span class="n">READY</span><span class="p">);</span>
			<span class="n">button</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="nf">SetActive</span><span class="p">(</span><span class="n">s</span> <span class="p">!=</span> <span class="n">LoadableWindowState</span><span class="p">.</span><span class="n">LOADING</span><span class="p">);</span>
			<span class="n">errorText</span><span class="p">.</span><span class="n">gameObject</span><span class="p">.</span><span class="nf">SetActive</span><span class="p">(</span><span class="n">s</span> <span class="p">==</span> <span class="n">LoadableWindowState</span><span class="p">.</span><span class="n">ERROR</span><span class="p">);</span>
		<span class="p">}).</span><span class="nf">AddTo</span><span class="p">(</span><span class="n">disposable</span><span class="p">);</span>
		<span class="n">button</span><span class="p">.</span><span class="n">onClick</span><span class="p">.</span><span class="nf">AsObservable</span><span class="p">().</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">u</span> <span class="p">=&gt;</span> <span class="n">model</span><span class="p">.</span><span class="nf">ButtonClicked</span><span class="p">()).</span><span class="nf">AddTo</span><span class="p">(</span><span class="n">disposable</span><span class="p">);</span>
		<span class="n">_viewModelSubscription</span> <span class="p">=</span> <span class="n">disposable</span><span class="p">;</span>
		<span class="n">_viewModelSubscription</span><span class="p">.</span><span class="nf">AddTo</span><span class="p">(</span><span class="n">gameObject</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span></code></pre></figure>

<p>Класс, теперь есть готовое окно. Но в стандартном подходе, мы бы не смогли потестить его, пока не готова бизнес логика. Она в свое время может быть завязана, например на сервер, или на другие части системы, которые еще не готовы.</p>

<p>На самом деле, у нас уже есть все, чтобы полноценно проверить все состояния UI.</p>

<p>Я создал отдельную сцену для теста окна, и отдельный скрипт, позволяющий проверить каждое из его состояний.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">LoadableWindowTest</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>


	<span class="k">public</span> <span class="n">LoadableWindow</span> <span class="n">window</span><span class="p">;</span>

	<span class="k">public</span> <span class="n">Button</span> <span class="n">setErrorButton</span><span class="p">;</span>
	<span class="k">public</span> <span class="n">Button</span> <span class="n">setReadyButton</span><span class="p">;</span>
	<span class="k">public</span> <span class="n">Button</span> <span class="n">loadContentButton</span><span class="p">;</span>
	<span class="k">public</span> <span class="n">Button</span> <span class="n">setLoadingButton</span><span class="p">;</span>

	<span class="k">private</span> <span class="n">LoadableWindowViewModel</span> <span class="n">_viewModel</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">LoadableWindowViewModel</span><span class="p">();</span>

	<span class="n">CompositeDisposable</span> <span class="n">_disposable</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CompositeDisposable</span><span class="p">();</span>

	<span class="k">private</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="n">window</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="n">_viewModel</span><span class="p">);</span>
		<span class="nf">LoadContent</span><span class="p">();</span>

		<span class="n">_viewModel</span><span class="p">.</span><span class="n">buttonClicked</span><span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">u</span> <span class="p">=&gt;</span> <span class="nf">ButtonClicked</span><span class="p">()).</span><span class="nf">AddTo</span><span class="p">(</span><span class="n">_disposable</span><span class="p">);</span>
		<span class="n">setErrorButton</span><span class="p">.</span><span class="n">onClick</span><span class="p">.</span><span class="nf">AsObservable</span><span class="p">().</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">u</span> <span class="p">=&gt;</span> <span class="nf">SetError</span><span class="p">()).</span><span class="nf">AddTo</span><span class="p">(</span><span class="n">_disposable</span><span class="p">);</span>
		<span class="n">setLoadingButton</span><span class="p">.</span><span class="n">onClick</span><span class="p">.</span><span class="nf">AsObservable</span><span class="p">().</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">u</span> <span class="p">=&gt;</span> <span class="nf">SetLoading</span><span class="p">()).</span><span class="nf">AddTo</span><span class="p">(</span><span class="n">_disposable</span><span class="p">);</span>
		<span class="n">setReadyButton</span><span class="p">.</span><span class="n">onClick</span><span class="p">.</span><span class="nf">AsObservable</span><span class="p">().</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">u</span> <span class="p">=&gt;</span> <span class="nf">SetContent</span><span class="p">()).</span><span class="nf">AddTo</span><span class="p">(</span><span class="n">_disposable</span><span class="p">);</span>
		<span class="n">loadContentButton</span><span class="p">.</span><span class="n">onClick</span><span class="p">.</span><span class="nf">AsObservable</span><span class="p">().</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">u</span> <span class="p">=&gt;</span> <span class="nf">LoadContent</span><span class="p">()).</span><span class="nf">AddTo</span><span class="p">(</span><span class="n">_disposable</span><span class="p">);</span>
		<span class="n">_disposable</span><span class="p">.</span><span class="nf">AddTo</span><span class="p">(</span><span class="n">gameObject</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="p">[</span><span class="nf">ContextMenu</span><span class="p">(</span><span class="s">"Set error"</span><span class="p">)]</span>
	<span class="k">private</span> <span class="k">void</span> <span class="nf">SetError</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="n">_viewModel</span><span class="p">.</span><span class="n">stateSubject</span><span class="p">.</span><span class="nf">OnNext</span><span class="p">(</span><span class="n">LoadableWindowState</span><span class="p">.</span><span class="n">ERROR</span><span class="p">);</span>
		<span class="n">_viewModel</span><span class="p">.</span><span class="n">buttonTitleSubject</span><span class="p">.</span><span class="nf">OnNext</span><span class="p">(</span><span class="s">"Retry"</span><span class="p">);</span>
		<span class="n">_viewModel</span><span class="p">.</span><span class="n">errorSubject</span><span class="p">.</span><span class="nf">OnNext</span><span class="p">(</span><span class="s">"Error text"</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">private</span> <span class="k">void</span> <span class="nf">SetContent</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="n">_viewModel</span><span class="p">.</span><span class="n">stateSubject</span><span class="p">.</span><span class="nf">OnNext</span><span class="p">(</span><span class="n">LoadableWindowState</span><span class="p">.</span><span class="n">READY</span><span class="p">);</span>
		<span class="n">_viewModel</span><span class="p">.</span><span class="n">contentSubject</span><span class="p">.</span><span class="nf">OnNext</span><span class="p">(</span><span class="s">"Loaded Content"</span><span class="p">);</span>
		<span class="n">_viewModel</span><span class="p">.</span><span class="n">buttonTitleSubject</span><span class="p">.</span><span class="nf">OnNext</span><span class="p">(</span><span class="s">"Refresh"</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">private</span> <span class="k">void</span> <span class="nf">SetLoading</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="n">_viewModel</span><span class="p">.</span><span class="n">stateSubject</span><span class="p">.</span><span class="nf">OnNext</span><span class="p">(</span><span class="n">LoadableWindowState</span><span class="p">.</span><span class="n">LOADING</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">private</span> <span class="k">void</span> <span class="nf">LoadContent</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="nf">SetLoading</span><span class="p">();</span>
		<span class="n">Observable</span><span class="p">.</span><span class="nf">Timer</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">3.0</span><span class="p">))</span>
			<span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">u</span> <span class="p">=&gt;</span> <span class="nf">SetContent</span><span class="p">())</span>
			<span class="p">.</span><span class="nf">AddTo</span><span class="p">(</span><span class="n">gameObject</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">public</span> <span class="k">void</span> <span class="nf">ButtonClicked</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="nf">LoadContent</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Скрипт посылает в модель соответствующие каждому состоянию данные. Отдельно я вытащил кнопки на каждое состояние и привязал их к скрипту.</p>

<p>Окно вставлено в сцену как префаб, тестовый скрипт – отдельная сущность. Таким образом мы можем играться с тестом не затрагивая реализацию окна.</p>

<p>Вот так это выглядит в живую:</p>

<p><img src="/imgs/loadable-window.gif" alt="живая демонстрация работы окна" /></p>

<h2 id="подводим-итоги">Подводим итоги</h2>

<p>В данной статье я продемонстрировал всего лишь наброски мыслей на тему. Подход может быть доработан и адаптирован под проект. Кто-то найдет некоторые части излишними и обойдется без них. Но в долгосрочной перспективе иметь UI как отдельный слой – однозначно выгодно.</p>]]></content><author><name>Ivan Fateev</name></author><category term="Programming" /><category term="Gamedev" /><category term="Programming" /><category term="Gamedev" /><summary type="html"><![CDATA[Это первая статья из цикла “Ускоряем разработку UI”. В этом цикле я хочу поднять проблему, которая у нас остро стояла на нескольких проектах. Одной из главных головных болей в повседневной разработке у нас частенько были UI задачи:]]></summary></entry><entry><title type="html">Важность понимания парадигмы. RX для работы с API</title><link href="https://fateev.me/ru/programming/understanding-paradigm-rx-for-api.html" rel="alternate" type="text/html" title="Важность понимания парадигмы. RX для работы с API" /><published>2018-10-12T07:00:00-05:00</published><updated>2018-10-12T07:00:00-05:00</updated><id>https://fateev.me/ru/programming/understanding-paradigm</id><content type="html" xml:base="https://fateev.me/ru/programming/understanding-paradigm-rx-for-api.html"><![CDATA[<p><img src="/imgs/paradigm-shift-graphic.jpg" alt="Paradigm shift - A change from one way thinking to another" /></p>

<p>Каждый день в нашей работе мы сталкиваемся с различными парадигмами. Не смотря на то, что большинство парадигм стары как мир (ООП, ФП и т.д.), часто всплывает что-то новое для нас. Возможно, что раньше мы не обращали внимание на них, или просто отсутствовала необходимость. Но теперь, когда она появилась, важно открыть свой разум, и освободить его от оков старых устоев.</p>

<p>Когда мы изучаем что-то новое, бывает сложно перестроиться. Что такое парадигма? Это философия, образ мышления. Если его не понять, не придерживаться ему, то использование инструментов парадигмы становится бессмысленным.</p>

<p>С этой проблемой столкнулись С++ программисты, когда популярность Си стала угасать, и многие Сишные программисты ринулись покорять новый, более популярный, более сложный язык. Проблема была в том, что С++ использовали как Си с классами, не пытаясь постичь ООП, соответствующие паттерны, ну вы поняли мысль.</p>

<p>Хотя люди и получили новый инструмент, они просто не хотели менять свой образ мышления. Ведь для этого нужно многое переосмыслить, поменять образ мышления. Не все этого хотят, не все на это способны.</p>

<p>Это я все к чему. <a href="https://ru.wikipedia.org/wiki/%D0%A0%D0%B5%D0%B0%D0%BA%D1%82%D0%B8%D0%B2%D0%BD%D0%BE%D0%B5_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5">Парадигма реактивного программирования</a> становится все более популярной. Если вы еще не знакомы с ней, я очень советую познакомиться.</p>

<p>Я вижу, как библиотеку RX (для Unity это <a href="https://github.com/neuecc/UniRx">UniRx</a>) пользуют в разных проектах. В частности, один из вариантов использования – это обертка над API. Оно и понятно, благодаря RX можно удобно комбинировать запросы, реагировать на ошибки и тому подобное.</p>

<p>Давайте посмотрим на пример. Я буду писать на .Net Core и Rx.Net, но его можно легко транслировать на Unity и UniRx. Если вы знакомы с RX, то можете пропустить следующую секцию, и перейти к <a href="#understanding-paradigm">следующей части</a></p>

<h2 id="пример-работы-с-api-через-rxnet">Пример работы с API через RX.Net</h2>

<p>Итак, предположим, у нас есть некий интерфейс коммуникации с сервером.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reactive</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reactive.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Game.Models</span><span class="p">;</span>

<span class="k">public</span> <span class="k">interface</span> <span class="nc">ILoginRepository</span> <span class="p">{</span>
    <span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">GetToken</span><span class="p">(</span><span class="kt">string</span> <span class="n">deviceId</span><span class="p">);</span>
    <span class="n">IObservable</span><span class="p">&lt;</span><span class="n">UserState</span><span class="p">&gt;</span> <span class="nf">GetUserSave</span><span class="p">(</span><span class="kt">string</span> <span class="n">token</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>Здесь есть две простейшие операции: получить токен и получить сейв. Как правило, при старте игры мы получаем токен (если он протух или его не было), затем получаем сейв. В принципе это может быть объединено и в одну операцию. Но для демонстрации идеи я их разделил.</p>

<p>Методы возвращают IObservable, что означает, что операция асинхронна, и может занять какое-то время.</p>

<p>Сделаем простейшую заглушку для интерфейса.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reactive.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Game.Models</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">LoginRepositoryStub</span> <span class="p">:</span> <span class="n">ILoginRepository</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">GetToken</span><span class="p">(</span><span class="kt">string</span> <span class="n">deviceId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">Observable</span><span class="p">.</span><span class="nf">Return</span><span class="p">(</span><span class="s">"stub_user_token"</span><span class="p">)</span>
                    <span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">1</span><span class="p">))</span>
                    <span class="p">.</span><span class="nf">SingleAsync</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="n">UserState</span><span class="p">&gt;</span> <span class="nf">GetUserSave</span><span class="p">(</span><span class="kt">string</span> <span class="n">token</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">Observable</span>
                    <span class="p">.</span><span class="nf">Return</span><span class="p">(</span><span class="k">new</span> <span class="nf">UserState</span><span class="p">())</span>
                    <span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">1</span><span class="p">))</span>
                    <span class="p">.</span><span class="nf">SingleAsync</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Здесь оба метода возвращают фиксированное значение с небольшой задержкой.</p>

<p>Обратите внимание, что здесь использован <code class="highlighter-rouge">SingleAsync</code>, который сразу закрывает стрим, после первого же события. Казалось бы, вполне логичное решение, ведь один запрос - один ответ.</p>

<p><code class="highlighter-rouge">UserState</code> пример класса сейва, просто для демонстрации.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">namespace</span> <span class="nn">Game.Models</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">UserState</span> <span class="p">{</span>
        <span class="k">public</span> <span class="kt">long</span> <span class="n">cash</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Ну и теперь попробуем это завести.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reactive.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reactive</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">understanding_paradigm</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">static</span> <span class="n">ILoginRepository</span> <span class="n">loginRepository</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">LoginRepositoryStub</span><span class="p">();</span>
        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Started the program"</span><span class="p">);</span>
            <span class="kt">bool</span> <span class="n">exit</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
            <span class="n">loginRepository</span><span class="p">.</span><span class="nf">GetToken</span><span class="p">(</span><span class="s">"device id"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">token</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Got token: </span><span class="p">{</span><span class="n">token</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="p">},</span> <span class="n">e</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Got exception while getting the token: </span><span class="p">{</span><span class="n">e</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="p">},</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Finished getting the token"</span><span class="p">);</span>
                    <span class="n">exit</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                <span class="p">});</span>
            <span class="k">while</span> <span class="p">(!</span><span class="n">exit</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Программа покажет следующий вывод:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Started the program
Got token: stub_user_token
Finished getting the token
</code></pre></div></div>

<p>Пока что все ок. Теперь попробуем сэмулировать ошибку сервиса. Привожу только измененные части.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">LoginRepositoryStub</span> <span class="p">:</span> <span class="n">ILoginRepository</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;</span> <span class="n">getTokenHandler</span><span class="p">;</span>

    <span class="k">private</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">ReturnToken</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Observable</span><span class="p">.</span><span class="nf">Return</span><span class="p">(</span><span class="s">"user_stub_token"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">1</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">SingleAsync</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">ReturnError</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Observable</span><span class="p">.</span><span class="n">Throw</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"Failed to get token"</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">1</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">SingleAsync</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">GetToken</span><span class="p">(</span><span class="kt">string</span> <span class="n">deviceId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">getTokenHandler</span> <span class="p">=</span> <span class="n">getTokenHandler</span> <span class="p">==</span> <span class="k">null</span>
                            <span class="p">?</span> <span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;)</span><span class="n">ReturnError</span>
                            <span class="p">:</span> <span class="n">ReturnToken</span><span class="p">;</span>

        <span class="k">return</span> <span class="nf">getTokenHandler</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>При первом запросе к GetToken возвращаю ошибку сервера. При втором, меняю имплементацию и возвращаю токен.</p>

<p>Запускаем программу, и видим, что она висит. Третье сообщение не выводится никогда.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Started the program
Got exception while getting the token: System.Exception: Failed to get token
</code></pre></div></div>

<p>Одна из частых ошибок – люди не предусматривают обработку завершения стрима с ошибкой. В данном случае ошибка обработана (выведена в консоль), но выход из программы не осуществлен, так как onComplete не вызвался. В данном случае в <code class="highlighter-rouge">exit = false</code> достаточно перенести в Finally.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">loginRepository</span><span class="p">.</span><span class="nf">GetToken</span><span class="p">(</span><span class="s">"device id"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Finally</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">exit</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">token</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Got token: </span><span class="p">{</span><span class="n">token</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">},</span> <span class="n">e</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Got exception while getting the token: </span><span class="p">{</span><span class="n">e</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">},</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Finished getting the token"</span><span class="p">);</span>
    <span class="p">});</span></code></pre></figure>

<p>Теперь, обычная практика, добавить retry и таймаут, мало ли, может плохое соединение, и можно повторить запрос.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">loginRepository</span><span class="p">.</span><span class="nf">GetToken</span><span class="p">(</span><span class="s">"device id"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Timeout</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">1</span><span class="p">))</span>
    <span class="p">.</span><span class="nf">Retry</span><span class="p">(</span><span class="m">3</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Finally</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="n">exit</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Finished getting the token"</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">token</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Got token: </span><span class="p">{</span><span class="n">token</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">},</span> <span class="n">e</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Got exception while getting the token: </span><span class="p">{</span><span class="n">e</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">});</span></code></pre></figure>

<p>Чтобы поддержать задержку ошибки, нужно немного изменить метод <code class="highlighter-rouge">ReturnError</code>:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">ReturnError</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Observable</span><span class="p">.</span><span class="nf">Return</span><span class="p">(</span><span class="s">"empty"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">10</span><span class="p">))</span>
                <span class="p">.</span><span class="nf">SelectMany</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">Observable</span><span class="p">.</span><span class="n">Throw</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"failed to get token"</span><span class="p">)));</span>
<span class="p">}</span></code></pre></figure>

<blockquote>
  <p>Обратите внимание! Мы не можем сделать просто <code class="highlighter-rouge">Observable.Throw&lt;string&gt;(new Exception("error")).Delay(TimeSpan.FromSeconds(10)))</code>. В таком случае Delay не будет работать, так как ошибка прерывает стрим моментально. Поэтому здесь я комбинирую стрим через SelectMany. Так же мы не можем воспользоваться Observable.Empty, так как он тоже сразу закроет стрим.</p>
</blockquote>

<p>Оператор Retry организован таким образом, что при возникновении ошибки, он переподписывается на стрим. В текущей реализации логика в методе <code class="highlighter-rouge">GetLogin()</code> не будет вызвана при переподписке. Поэтому необходимо его обновить.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">GetToken</span><span class="p">(</span><span class="kt">string</span> <span class="n">deviceId</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">Observable</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="n">observer</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"GetToken called"</span><span class="p">);</span>
        <span class="n">getTokenHandler</span> <span class="p">=</span> <span class="n">getTokenHandler</span> <span class="p">==</span> <span class="k">null</span>
                            <span class="p">?</span> <span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;)</span><span class="n">ReturnError</span>
                            <span class="p">:</span> <span class="n">ReturnToken</span><span class="p">;</span>
        <span class="k">return</span> <span class="nf">getTokenHandler</span><span class="p">().</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">observer</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span></code></pre></figure>

<p>Здесь используется фабрика Observable.Create, которая будет вызывать функтор при каждой подписке. Таким образом мы можем быть уверены, что возвращаем разные результаты при Retry.</p>

<p>Запускаем программу:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Started the program
GetToken called
GetToken called
GetToken called
Got exception while getting the token: System.TimeoutException: The operation has timed out.
Finished getting the token
</code></pre></div></div>

<p>GetToken вызвался трижды, при этом весь стрим завершился с ошибкой таймаута. Если мы изменим задержку на приемлемые значения, то увидим следующий вывод:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Started the program
GetToken called
GetToken called
Got token: user_stub_token
</code></pre></div></div>

<p>Прилеплять логику по ретраю и таймауту извне не красиво, поэтому мы можем перенести это в репозиторий.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="k">class</span> <span class="nc">APIRxExtensions</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">DEFAULT_TIMEOUT_SECS</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">DEFAULT_RETRY_COUNT</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">WrapWithRetryAndTimeout</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">observable</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">observable</span>
                <span class="p">.</span><span class="nf">Retry</span><span class="p">(</span><span class="n">DEFAULT_RETRY_COUNT</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Timeout</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="n">DEFAULT_TIMEOUT_SECS</span><span class="p">));</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">LoginRepositoryStub</span> <span class="p">{</span>
    <span class="k">public</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">GetToken</span><span class="p">(</span><span class="kt">string</span> <span class="n">deviceId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">Observable</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="n">observer</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"GetToken called"</span><span class="p">);</span>
            <span class="n">getTokenHandler</span> <span class="p">=</span> <span class="n">getTokenHandler</span> <span class="p">==</span> <span class="k">null</span>
                                <span class="p">?</span> <span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;)</span><span class="n">ReturnError</span>
                                <span class="p">:</span> <span class="n">ReturnToken</span><span class="p">;</span>
            <span class="k">return</span> <span class="nf">getTokenHandler</span><span class="p">().</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">observer</span><span class="p">);</span>
        <span class="p">}).</span><span class="nf">WrapWithRetryAndTimeout</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Ну и в конце, после авторизации, нам нужно получить UserState.</p>

<p>Таким образом, Retry и Timeout будут инкапсулированы в репозитории, и пользователю не нужно о них думать.</p>

<p>Финальный стрим будет выглядеть следующим образом:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">IDisposable</span> <span class="n">disposable</span> <span class="p">=</span> <span class="n">loginRepository</span><span class="p">.</span><span class="nf">GetToken</span><span class="p">(</span><span class="s">"device id"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">SelectMany</span><span class="p">(</span><span class="n">token</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Got token: </span><span class="p">{</span><span class="n">token</span><span class="p">}</span><span class="s">. Fetching user state"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">loginRepository</span><span class="p">.</span><span class="nf">GetUserSave</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">state</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"state: "</span> <span class="p">+</span> <span class="n">state</span><span class="p">);</span>
                    <span class="k">return</span> <span class="n">state</span><span class="p">;</span>
                <span class="p">});</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nf">Finally</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="n">exit</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Finished getting the token"</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">userState</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"User's cash: </span><span class="p">{</span><span class="n">userState</span><span class="p">.</span><span class="n">cash</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="n">e</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Got exception while getting the state: </span><span class="p">{</span><span class="n">e</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Completed"</span><span class="p">);</span>
    <span class="p">});</span></code></pre></figure>

<h2 id="соблюдаем-философию-rx">Соблюдаем философию RX</h2>
<p><a name="understanding-paradigm"></a></p>

<p>Итак, давайте подведем краткие итоги. На данном этапе ясно, что RX позволяет легко и прозрачно внедрять логику вроде ретрая или таймаутов. В целом, логика работы с асинхрорнными операциями выглядит более стройно и понятно.</p>

<blockquote>
  <p>Пытливый ум читателя может заметить, что то же самое можно было бы сделать с помощью async/await, но не во всех версиях Unity/С# оно доступно, да и обработка ошибок, на мой взгляд, при таком подходе, не так прозрачна. В любом случае – решать вам.</p>
</blockquote>

<p>Давайте вернемся к началу статьи. Я сказал, что важно понимать парадигму, чтобы максимально извлекать из нее выгоду. Что в приведенном мною примере не так?</p>

<p>Реактивное программирование потому и называется реактивным, что весь код должен реагировать на события. Мы должны создавать все стримы событий заранее. Тогда мы будем уверены, что, когда прилетит событие, все обновится как надо.</p>

<p>В описанном же примере стрим “пассивный”. То есть посылка запроса происходит во время подписки на событие. Мы одновременно запрашиваем данные, и их читаем. Более того, такая подписка действую всего лишь один раз, из-за <code class="highlighter-rouge">SingleAsync</code>.</p>

<p>Это очень ограничивает варианты использования кода. Например, мы можем либо привязать код обновления к загрузке какого-либо вью, либо к кнопке “refresh”. Если нам нужны обновления в реальном времени, то мы делаем периодический refresh, что совсем не красиво.</p>

<p>Не смотря на то, что это естественно для REST API, это убивает всю гибкость и выгоду от RX.</p>

<p>В идеологии RX, запрос данных и реакция на событие об обновлении данных — две разные задачи, которые должны обрабатываться отдельно. Если вы знакомы с паттерном <a href="https://ru.wikipedia.org/wiki/Model-View-ViewModel">MVVM</a>, то можете заметить, что в нем изменение модели и обновление вьюхи разделено. Обновление вью производится с помощью байндингов, которые реагируют на события. Изменение модели производится с помощью команд.</p>

<p>RX по сути требует такого же подхода. Как же это воплотить при работе с API?</p>

<h2 id="reactive-api">Reactive API</h2>

<p>Представим, что запрос данных — это команда в терминах MVVM. А ответы от API – это событие, которое может прикатить в любое время. Если мы их разделим, то все вьюхи при старте сразу могут подписаться на событие обновления, а мы можем быть уверены, что данные будут всегда акутальны.</p>

<p>Запросить же обновление данных мы можем из любого места программы. При этом, в отличие от предыдущего подхода, нам не нужно будет менять код обновления view. Да и вообще мы можем быть совершенно отвязаны от view.</p>

<p>Итак, интерфейс меняется следующим образом:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">interface</span> <span class="nc">ILoginRepository</span> <span class="p">{</span>
    <span class="err">#</span><span class="n">region</span> <span class="n">commands</span>

    <span class="k">void</span> <span class="nf">fetchToken</span><span class="p">(</span><span class="kt">string</span> <span class="n">deviceId</span><span class="p">);</span>
    <span class="k">void</span> <span class="nf">fetchUserSave</span><span class="p">(</span><span class="kt">string</span> <span class="n">token</span><span class="p">);</span>

    <span class="err">#</span><span class="n">endregion</span>

    <span class="err">#</span><span class="n">region</span> <span class="n">events</span>

    <span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">GetTokenObservable</span><span class="p">();</span>
    <span class="n">IObservable</span><span class="p">&lt;</span><span class="n">UserState</span><span class="p">&gt;</span> <span class="nf">GetUserSaveObservable</span><span class="p">();</span>

    <span class="err">#</span><span class="n">endregion</span>
<span class="p">}</span></code></pre></figure>

<p>По интерфейсу сразу понятно как данные запросить, и как подписаться на обновления.</p>

<p>Теперь к реализации.</p>

<p>Что я меняю первым делом – создаю отдельные Observable:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">LoginRepositoryStub</span> <span class="p">:</span> <span class="n">ILoginRepository</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">BehaviorSubject</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">_tokenSubject</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BehaviorSubject</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="k">null</span><span class="p">);</span>
    <span class="k">private</span> <span class="n">BehaviorSubject</span><span class="p">&lt;</span><span class="n">UserState</span><span class="p">&gt;</span> <span class="n">_userStateSubject</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BehaviorSubject</span><span class="p">&lt;</span><span class="n">UserState</span><span class="p">&gt;(</span><span class="k">null</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>BehaviorSubject — классная штука. При подписке на него он сразу эммитит последнее известное ему onNext значение. Таким образом, если токен уже был получен, то подписчик будет обладать актуальным значением. Это такой своеобразный кэш.</p>

<p>Если в какой-то момент мы поймем, что токен надо обновить, то достаточно просто вызывать fetchToken() и все заинтересованные его получат.</p>

<p>Даже если нам необходимо периодическое обновление, то его легко сделать в одном месте по таймеру. Подписчиков может быть сколь угодно много.</p>

<p>Но это еще не все. Часто в приложениях нужен прямо таки настоящий реалтайм, когда сервер уведомляет клиент об изменениях. Например, с использованием сокетов. Если это ваш случай, то изменить код с REST API на сокеты элементарно. Все подписки остаются прежними. Меняется только транспорт: присоединяемся к сокету, и прокидываем событие в BehaviorSubject.</p>

<p>Важный момент: такой стрим не завершается никогда, при нормальных обстоятельствах. Если стрим закрылся, то это либо программа завершается, либо произошла ошибка. То есть, например, http ошибки прокидывать в этот стрим не нужно. Вся обработка ошибок должна уйти на другой слой логики.</p>

<p>Итак, давайте посмотрим как изменилась реализация с разделением кода.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">LoginRepositoryStub</span> <span class="p">:</span> <span class="n">ILoginRepository</span>
<span class="p">{</span>

    <span class="c1">// нужно учитывать, что при подписке может прийти null</span>
    <span class="k">private</span> <span class="n">BehaviorSubject</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">_tokenSubject</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BehaviorSubject</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="k">null</span><span class="p">);</span>
    <span class="c1">// нужно учитывать, что при подписке может прийти null</span>
    <span class="k">private</span> <span class="n">BehaviorSubject</span><span class="p">&lt;</span><span class="n">UserState</span><span class="p">&gt;</span> <span class="n">_userStateSubject</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BehaviorSubject</span><span class="p">&lt;</span><span class="n">UserState</span><span class="p">&gt;(</span><span class="k">null</span><span class="p">);</span>

    <span class="k">private</span> <span class="n">Action</span> <span class="n">getTokenHandler</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">ReturnToken</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">_tokenSubject</span><span class="p">.</span><span class="nf">OnNext</span><span class="p">(</span><span class="s">"user_stub_token"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">GetTokenObservable</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">_tokenSubject</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="n">UserState</span><span class="p">&gt;</span> <span class="nf">GetUserSaveObservable</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">_userStateSubject</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">fetchToken</span><span class="p">(</span><span class="kt">string</span> <span class="n">deviceId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// вся логика работы с транспортом должна уйти на этот слой</span>
        <span class="n">Observable</span><span class="p">.</span><span class="nf">Timer</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">1</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">__</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="nf">ReturnToken</span><span class="p">();</span>
            <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">fetchUserSave</span><span class="p">(</span><span class="kt">string</span> <span class="n">token</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// вся логика работы с транспортом должна уйти на этот слой</span>
        <span class="n">Observable</span><span class="p">.</span><span class="nf">Timer</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">1</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">__</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="n">_userStateSubject</span><span class="p">.</span><span class="nf">OnNext</span><span class="p">(</span><span class="k">new</span> <span class="nf">UserState</span><span class="p">());</span>
            <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Здесь я сделал просто заглушку, которая присылает события с задержкой. Но на деле, в этом месте должен посылаться запрос и обрабатываться ошибки. Если пользователю нужно знать об ошибке, то нужно вывесить отдельный Observable с человекопонятным типом ошибки.</p>

<p>Теперь посмотрим на сам стрим.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Started the program"</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="n">exit</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="n">IDisposable</span> <span class="n">disposable</span> <span class="p">=</span> <span class="n">loginRepository</span><span class="p">.</span><span class="nf">GetTokenObservable</span><span class="p">()</span>
        <span class="p">.</span><span class="nf">Finally</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Closing token observable"</span><span class="p">);</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">token</span> <span class="p">=&gt;</span> <span class="n">token</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">token</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Got token </span><span class="p">{</span><span class="n">token</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
            <span class="n">loginRepository</span><span class="p">.</span><span class="nf">fetchUserSave</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="n">e</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Got exception while getting the token: </span><span class="p">{</span><span class="n">e</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="p">});</span>

    <span class="n">loginRepository</span><span class="p">.</span><span class="nf">GetUserSaveObservable</span><span class="p">()</span>
        <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">state</span> <span class="p">=&gt;</span> <span class="n">state</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">Subscribe</span><span class="p">(</span><span class="n">state</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"User's cash: </span><span class="p">{</span><span class="n">state</span><span class="p">.</span><span class="n">cash</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
            <span class="n">exit</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">});</span>

    <span class="n">loginRepository</span><span class="p">.</span><span class="nf">fetchToken</span><span class="p">(</span><span class="s">"device id"</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(!</span><span class="n">exit</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Интересные моменты:</p>

<ol>
  <li>Теперь две отдельные подписки</li>
  <li>Подписки учитывают, что может прийти null, поэтому фильтруют ивенты</li>
  <li>Команды на запрос данных могут находиться в любом месте программы, как до подписки, так и после. Завязка на порядок вызова отсутствует.</li>
</ol>

<h2 id="подводим-итоги">Подводим итоги</h2>

<p>Фух, получилась довольно большая статья. Но основная мысль такова: недостаточно использовать парадигму, нужно полностью понять и принять ее философию. Если мы это не делаем, то сильно себя ограничиваем, тем самым теряя всю пользу от подхода.</p>

<p>Сделаю удобную работу с API можно и нужно. Если утилизировать возможность реактивности по максимуму, разделяя запросы и события, то код будет понятен и предсказуем.</p>

<p>Тем не менее, я хочу предостеречь о сложностях отладки RX стримов. когда что-то не работает, приходится повозится, зарываясь в дебрях колстека. Это один из негативных моментов работы с RX, да и ФП в целом.</p>

<p>Как всегда, если у вас есть мысли по теме — буду рад услышать. Комменты, или ПМ приветствуются.</p>

<p>Исходный код по теме <a href="https://github.com/PoisonousJohn/articles/tree/master/Telegram_Posts/understanding-paradigm">здесь</a>.</p>]]></content><author><name>Ivan Fateev</name></author><category term="Programming" /><category term="Programming" /><summary type="html"><![CDATA[Каждый день в нашей работе мы сталкиваемся с различными парадигмами. Не смотря на то, что большинство парадигм стары как мир (ООП, ФП и т.д.), часто всплывает что-то новое для нас. Возможно, что раньше мы не обращали внимание на них, или просто отсутствовала необходимость. Но теперь, когда она появилась, важно открыть свой разум, и освободить его от оков старых устоев.]]></summary></entry><entry><title type="html">Средства отладки</title><link href="https://fateev.me/ru/gamedev/debug-tools.html" rel="alternate" type="text/html" title="Средства отладки" /><published>2018-09-05T09:50:30-05:00</published><updated>2018-09-05T09:50:30-05:00</updated><id>https://fateev.me/ru/gamedev/debug-tools</id><content type="html" xml:base="https://fateev.me/ru/gamedev/debug-tools.html"><![CDATA[<p>Сколько времени мы тратим в день, разбираясь в коде? Согласно <a href="https://blog.codinghorror.com/when-understanding-means-rewriting/">этой статье</a> — 75%.</p>

<figure class="">
  <img src="/imgs/coding-activity-chart.png" alt="График: 75% -- понимание кода; 5% -- написание нового кода; 20% -- изменение существующего кода" /><figcaption>
      Источник: <a href="https://dmitripavlutin.com/coding-like-shakespeare-practical-function-naming-conventions/">dmitripavlutin.com</a>

    </figcaption></figure>

<p>Это не удивительно. Хотя есть такая тенденция, что за людьми закрепляют какие-то части системы, все равно нам каждый день приходится читать чужой код. Свой код бывает понять сложно, а чужой дается нам еще тяжелее.
Я уже писал про <a href="https://medium.com/gamedev-architecture/%D0%B0%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0-%D0%B8-%D0%BA%D0%BE%D0%BC%D0%B0%D0%BD%D0%B4%D0%BD%D0%B0%D1%8F-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0-fd05952111f8">командную работу</a> и про <a href="https://medium.com/gamedev-architecture/%D0%B0%D0%B1%D1%81%D1%82%D1%80%D0%B0%D0%BA%D1%86%D0%B8%D1%8F%D0%BC%D0%B8-%D1%82%D0%B5%D0%B1%D0%B5-%D0%BF%D0%BE-%D0%B3%D0%BE%D0%BB%D0%BE%D0%B2%D0%B5-d10655098020">любителей абстракций</a> в которых затрагивалась тема когнитивной нагрузки. Каждый день на нашей работе мы грузим свою голову по полной. И чем нагрузка выше, тем больше вероятность, что мы не захотим разбираться в том что есть, и начнем искать другие способы исправить/обойти ситуацию.</p>

<p>Чтобы не прийти к неправильным решениям, вроде поверхностных костылей, переписывания с нуля, и т.п., нужно иметь ввиду способ, который значительно помогает снизить когнитивную нагрузку.</p>

<p>Процесс понимания кода сильно помогает анализ его работы в рантайме. И тут уже, как раз, есть где развернуться воображению.</p>

<h2 id="визуализация-как-способ-снизить-когнитивную-нагрузку">Визуализация как способ снизить когнитивную нагрузку</h2>

<p>Самым простым средством отладки являются логи. При отсутствии возможности использовать нормальный отладчик, мы можем прибегнуть к консоли и логам. Но тут есть нюанс. Разбиратсья в логах – это как проводить расследование.</p>

<ul>
  <li>логи нужно сопоставлять с кодом, и тогда уже делать умозаключение</li>
  <li>логи не просто читать, так как там бывает много лишнего, и нужно выцеплять только самое важное</li>
  <li>логи сложно смотреть и анализировать в реальном времени</li>
</ul>

<p>все это в комплексе может только увеличить нагрузку на ваш мозг.</p>

<p>Другое дело, если вы можете визуализировать все эти вещи. Человек так устроен, что графику ему воспринимать гораздо проще, чем текст. Именно поэтому консольные интерфейсы были вытеснены графическими. (Вы не подумайте, я все равно фанат консоли).</p>

<p>Gizmos в Unity – очень удобное средство для отладки. Вот вам <a href="https://habr.com/post/279929/">один пример</a>.</p>

<p>Другой пример я приведу из жизни. Я работал над match3 игрой, с довольно сложной бизнес-логикой. Фишки имели кучу статусов, на них могла повлиять куча событий. Во время геймплея на поле уследить за всем сразу невозможно.</p>

<p>В какой-то момент на поле просто все ломалось. Например, фишка залипала в середине поля и никуда не двигалась. Почему это произошло, в какой момент, как это повторить? Выяснить эти вопросы было большой проблемой.</p>

<p>Начинал я с логов. Смотря на логи я прогонял все в голове на предмет возможных ошибок. Но этот способ быстро показал себя неэффективным. На поле происходило слишком много событий, и вычленить что-то важное было довольно сложно.</p>

<p>В редких случаях удавалось понять конкретные шаги по воспроизведению бага, тогда любимый отладчик спасал.</p>

<p>Касательно отсальных случаев, я понял, что без визуального дебага мне не справиться. Поэтому для игрового поля я сделал Gizmos, которые рисовали разную полезную инфу:</p>

<ul>
  <li>текущий статус фишки</li>
  <li>заблокирована или не заблокирована ячейка</li>
  <li>куда посыпятся фишки, если им нужно будет обтекать препятствия и т.д.</li>
</ul>

<p>Следить за полем в реальном времени стало сразу намного проще. Чтобы понять какая фишка в каком статусе, мне не надо было копать логи или ставить брейкпоинт, я могу просто посмотреть в соседнее окно. Ко всему прочему, я мог ставить игру на паузу, и, шагая по фреймам, видеть что происходит на поле под капотом.</p>

<p>Затем, я добавил краткую очередь/историю обработки команд, из которой было понятно что проиходило/произойдет на поле в ближайшее время.</p>

<p>Визуализация позволяет снизить нагрузку на наш мозг, что позволяет легче интерпретировать работу кода в рантайме. Держать в голове матрицу 8x8 с кучей состояний – то еще удовольствие, я вам скажу. Другое дело – видеть все перед глазами.</p>

<p>Еще, как пример, возьмем стейт-машину в Unity. Если бы она визуально не отображала переходы, в рантайме не показывала текущее состояние, то отладка была бы значительно сложнее.</p>

<h2 id="читы-как-способ-упростить-отладку">Читы как способ упростить отладку</h2>

<p>Читы – тоже мощное средство. Если вы часто делаете какое-либо действие, чтобы что-то отладить, и оно занимает много усилий, то его обязательно надо автоматизировать читом. Возвращаясь к примеру match3, забиндив несколько шорткатов а-ля ctrl+click, shift+click я сделал применение различных бонусов на поле. Это позволило мне создавать тестовые кейсы просто покликав.</p>

<p>Позже я добавил возможность сохранять и загружать какое-либо состояние поле и отсылать его с устройства, чтобы потом можно было загрузить у себя.</p>

<p>Полезных читов может быть очень очень много, никогда не бойтесь тратить на них время. Они окупят себя сторицей. Тестеры вас тоже за них отблагодарят.</p>

<h2 id="слепок-состояния">Слепок состояния</h2>

<p>Я уже писал, что, если игра позволяет, то можно делать слепки состояний, с полными логами команд, как я <a href="https://habr.com/company/microsoft/blog/350630/">описал здесь</a>. Кстати, использование кастомных окон и эдиторов в Unity – это тоже великолепный способ упростить отладку.</p>

<h2 id="удаленная-консоль">Удаленная консоль</h2>

<p>Помните консоль в quake? Бывает так, что баг воспроизводся только на устройстве. Тогда нужно иметь продвинутые средства отладки. Например, полезно посмотреть иерархию объектов сцены, что довольно затруднительно, если вы отлаживаетесь на устройстве.</p>

<p>Или, может, нужно иметь возможность повлиять как-то на объекты сцены: дампануть состояние, передвинуть и т.д. Если встроить в приложение http сервер, которые умеет принимать команды, то можно замутить интересные средства для отладки.</p>

<h2 id="unit-тесты-как-быстрый-способ-проверить-утверждения">Unit-тесты как быстрый способ проверить утверждения</h2>

<p>Unit-тесты полезны не только для того, чтобы следить за тем, что мы что-то поломали. Один из моих любимых способов разбираться в коде – это писать маленькие Unit-тесты для проверки предположений.</p>

<p>Например, если я вижу какой-то кусок кода, который исполняется только у high-level пользователей, обычно мне надо запустить игру, зачитить себе уровень, накидать, например, айтем, который связан с этим кодом, и только тогда я могу его проверить.</p>

<p>Вместо этого пути, я могу по быстрому накидать маленький unit-test и проверить свое предположение. Для меня это работает значительно быстрее, чем проверять все в рантайме игры.</p>

<h2 id="подводим-итоги">Подводим итоги</h2>

<p>На самом деле, список далеко не полный. Он ограничивается только вашей фантазией. Я часто вижу, что люди мучаются, стонут, выполняя одни и те же действия. Жалуются, стонут, но продлжают делать так же.</p>

<p>Мы же с вами программисты, так почему не упростить себе жизнь? Задумайтесь, может и вам можно придумать какое-нибудь средство для отладки, которое сделает вас немножко счастливее. Или, быть может, вы давно откладывали это на потом? Значит вот он знак, пора бы этим заняться ;)</p>]]></content><author><name>Ivan Fateev</name></author><category term="Gamedev" /><category term="Gamedev" /><category term="Tools" /><summary type="html"><![CDATA[Сколько времени мы тратим в день, разбираясь в коде? Согласно этой статье — 75%.]]></summary></entry><entry><title type="html">Система компонентов cущностей (Entity Component System)</title><link href="https://fateev.me/ru/gamedev/entity-component-system.html" rel="alternate" type="text/html" title="Система компонентов cущностей (Entity Component System)" /><published>2018-07-20T09:33:30-05:00</published><updated>2018-07-20T09:33:30-05:00</updated><id>https://fateev.me/ru/gamedev/component-system</id><content type="html" xml:base="https://fateev.me/ru/gamedev/entity-component-system.html"><![CDATA[<p>Использование паттерна “Компонент” – это единственная альтернатива не потеряться среди леса из деревьев наследования. Я поясню.</p>

<p>Когда люди работают над сложными механиками, они пытаются выделить общие части системы, чтобы их переиспользовать. Но так случается, что общие части должны присутствовать в совершенно несвязанных модулях.</p>

<p>Частая ошибка – пытаться объединить то, что должно лежать раздельно. Из-за того, что общий функционал нужен в двух несвязанных ветках наследования, а большинство языков не поддерижвают множественное наследование, то люди извращаются как могут. Впиливают куда-нибудь наверх еще уровень наследования, чтобы где-то через несколько уровней вниз, 2 класса использовали 1-2 метода.</p>

<p><img src="/imgs/inheritance-problem.png" alt="Inheritance-problem-diagram" /></p>

<p>Часто еще бывает, что этот Common класс не используется целиком, и среди всей иерархии тащатся бесполезные части.</p>

<h2 id="component-pattern">Component pattern</h2>

<p>Если использовать шаблон <a href="http://gameprogrammingpatterns.com/component.html">Component</a>, то все упрощается. Мы просто меняем наследование на композицию, добавляем там где нам нужно компонент, и вызываем методы.</p>

<p><img src="/imgs/inheritance-problem2.png" alt="Inheritnace-problem-diagram" /></p>

<p>Теперь у нас ничего лишнего в родительских классах, все выглядит почище. Не смотря на то, что решение простое, и, казалось бы, интуитивное, люди, почему-то, все равно хотят использовать наследование, как одержимые.</p>

<h2 id="entity-component-pattern">Entity Component Pattern</h2>

<p>Я не смог найти правильное название для этого шаблона. Это что-то среднее между использование компонентов, что я рассмотрел ранее, и Entity Component System, что мы рассмотрим позже.</p>

<p>Предыдущий подход имеет один большой недостаток: использование всех компонентов зашито в коде. То есть, мы не можем добавить к классу игрока новый компонент, не поменяв код.</p>

<p>Это может быть довольно сильным ограничением, ведь геймплей должен быть настраиваемым. Если каждый раз гейм-дизайнер будет дергать программиста, чтобы изменить скорость перемещения персонажа – это катастрофа.</p>

<p>Для этого в играх есть некая система для конфигурации. Если можно конфигурировать то что уже написано в коде, так почему бы не дать еще больше свободы для креатива и не “хардкодить” поведение заранее.</p>

<p>Шаблон Entity Component – это то, как работает вся система в Unity. Идея, на самом деле неплохая, но реализация так себе. О ее недостатках все известно, но мы часто забываем о преимуществах.</p>

<p>Данный шаблон предполагает, что все в программе – это некая “Сущность (Entity)”. В терминах Unity сущность – это GameObject. И каждая сущность может иметь набор компонентов. Они заранее не определены и их список может меняться посредством методов.</p>

<p>Если откинуть мысли о производительности, то давайте посмотрим какое преимущество нам дает такая система.</p>

<h3 id="классический-пример">Классический пример.</h3>

<p>Есть, например, шутер. В нем есть игроки, которые палят друг в друга, пока не прикончат. Внезапно гейм-дизайнер решил, что в игре должны быть и разрушаемые предметы, причем разрушаться они должны после определенного урона.</p>

<p>Компоненты позволяют отделить код от конфигурации/представления. Поэтому, если программисты делали свою работу хорошо, и сделали отдельный компонент, который имеет “здоровье” и может принимать урон, то разрушение чего-угодно решается простым добавлением компонента к объекту.</p>

<p>В юнити, гейм-дизайнер может открыть “префаб” камня, например, и добавить к нему соответствующий компонент. Если бы у нас не было такой возможности, то программисту понадобилось бы искать условный класс “Камень” и добавлять компонент в код.</p>

<p>Немного программер-арта:</p>

<p><img src="/imgs/health-component.jpg" alt="Health component attached to every object" /></p>

<p>HealthComponent приаттачен как к плеерам, так и к камню, что позволяет сразу получить весь необходимый функционал, включая отображение полосок здоровья.</p>

<p>Еще одна приятная возможность такой системы, что компоненты можно аттачить к объектам в рантайме, по какому-либо событию, что тоже позволяет делать интересные механики.</p>

<p>Это классный паттерн, но у него есть свои недостатки:</p>

<ul>
  <li>мы не знаем какие компоненты есть у объекта заранее, можем определить это только в рантайме, что рождает все эти ошибки, когда мы пытаемся использовать компонент, которого нет</li>
  <li>зависимости между компонентами сложнее реализовать и отслеживать</li>
  <li>такая система бьет по производительности, так как многие вещи делаются в рантайме</li>
</ul>

<p>Но преимущества сильно перевешивают недостатки, имхо.</p>

<h2 id="entity-component-system">Entity Component System</h2>

<p>На самом деле, шаблон <a href="https://github.com/junkdog/artemis-odb/wiki/Introduction-to-Entity-Systems">Entity Component System (ECS)</a> очень похож на предыдущий вариант. С одним ключевым отличием: бизнес логика по обработке компонентов лежит в системах, а не в самих компонентах.</p>

<p>В отличие от предыдущего подхода, где, например, метод Update присутствует в каждом отдельном компоненте, в ECS есть система обработки компонентов, которая имеет список всех компонентов одного типа, и, итерируясь по ним, исполняет бизнес логику.</p>

<p>В чем здесь выгода?</p>

<h3 id="порядок-обработки-компонентов-системами-четко-регламентирован">Порядок обработки компонентов системами четко регламентирован</h3>

<p>В каком порядке системы были зарегистрированы в ECS, в таком они и обработают компонент. Это дает высокую предсказуемость кода. Когда отлаживаешь баги, то почти сразу можно локализовать место, где данные поломались.</p>

<h3 id="легко-включать-и-выключать-логику">Легко включать и выключать логику</h3>

<p>Попробуйте в Unity отключить все MonoBehavior определенного типа. Это возможно, но будет проблематично:</p>

<ul>
  <li>Найти все компоненты типа T и выключить их: FindObjectsOfType<T>, который по сути итерируется по всем объектам в сцене.</T></li>
  <li>Сделать статическую переменную в классе компонента и проверять ее внутри Update и других методов, т.е. по сути исполнять N раз одну и ту же работу в каждом компоненте.</li>
  <li>Прикреплять компоненты одного типа к одному game object и включать/выключать его</li>
</ul>

<p>Если у вас есть система физики, которая работает с рядом физических компонентов, обновляя их, то выключить физику можно простейшим выключением апдейта самой системы.</p>

<p>Аналогично, если в Update есть какое-то вычисление, одинаковое для всех компонентов, то система его может закэшировать.</p>

<p>Итерация и обработка однотипных компонентов происходит гораздо быстрее.</p>

<p>Система может манипулировать несколькими типами компонентов и эффективно их обрабатывать, решая проблему зависимостей и взаимодействия. Даже если у вас несколько типов компонентов, код логично сгруппирован в системе.</p>

<h3 id="легко-писать-тесты">Легко писать тесты</h3>

<p>Так как системы сосредоточены на одной задаче, слабо связаны и оперируют только данными в компонентах, то писать тесты – сущая легкотня.</p>

<p>Фикстуры – это просто набор компонентов-данных.
Мокать ничего практически не нужно.
Проверять вход и выход системы в тестах – элементарно!</p>

<h3 id="модульность-кода">Модульность кода</h3>

<p>ECS позволяет организовывать модульный код. Имеется ввиду, что какая-то фича может состоять из ряда компонентов и группы систем по их обработке. Они должны быть связаны вместе, потому что не могут работать друг без друга (вспоминаем high cohesion). Вместе они образуют фича-модуль.</p>

<p>Если правильно организовать код и держать связанные вещи рядом, организуя их в модули, а между модулями выстроить границы (вспоминаем loose coupling), то получится классная архитектура.</p>

<p>К примеру, начиная новый прототип, можно легко перетаскивать и подключать целые модули. Здесь мы хотим модуль стрельбы от первого лица, а вот здесь мы хотим NAVMeshAI для мобов, а вот здесь мы подключим модуль с индикаторами здоровья врагов.</p>

<p>А если мы резко передумали и решили что-то выпилить – тоже не проблема, не нужно перелопачивать весть код удаляя там-сям.</p>

<p>Вот, например, пачка систем оружия из реального проекта, которы могут быть объединены в модуль:</p>
<pre>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">      <span class="n">systems</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">FireIfWeaponReadySystem</span><span class="p">(</span><span class="n">_superContext</span><span class="p">));</span>
      <span class="n">systems</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">WeaponReloadTriggerSystem</span><span class="p">(</span><span class="n">_superContext</span><span class="p">));</span>
      <span class="n">systems</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">UpdateReloadTimer</span><span class="p">(</span><span class="n">_superContext</span><span class="p">));</span>
      <span class="n">systems</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">UpdatePostReloadTimer</span><span class="p">(</span><span class="n">_superContext</span><span class="p">));</span>
      <span class="n">systems</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">StartReloadTimerSystem</span><span class="p">(</span><span class="n">_superContext</span><span class="p">));</span>
      <span class="n">systems</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">UpdateThrowingGrenadeSystem</span><span class="p">(</span><span class="n">_superContext</span><span class="p">));</span>
      <span class="n">systems</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">UpdateSpitSystem</span><span class="p">(</span><span class="n">_superContext</span><span class="p">));</span>
      <span class="n">systems</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">WeaponShootSystem</span><span class="p">(</span><span class="n">_superContext</span><span class="p">));</span>
      <span class="n">systems</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">ModifyDamageSystem</span><span class="p">(</span><span class="n">_superContext</span><span class="p">));</span>
      <span class="n">systems</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">ApplyHitSystem</span><span class="p">(</span><span class="n">_superContext</span><span class="p">));</span>
      <span class="n">systems</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">WeaponRecoilSystem</span><span class="p">(</span><span class="n">_superContext</span><span class="p">));</span>
      <span class="n">systems</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">WeaponUpdateRecoilSystem</span><span class="p">(</span><span class="n">_superContext</span><span class="p">));</span></code></pre></figure>

</pre>

<h2 id="практический-кейс-используем-плюшки-низкой-связности-ecs-для-привязки-аналитики">Практический кейс: используем плюшки низкой связности ECS для привязки аналитики</h2>

<p>Интеграция аналитики в проект – всегда геморная задача. Нет, дело не в сложности, а в том, что красиво аналитику в проект вставить сложно. Она часто “размазана” по коду то там, то здесь. Она редко ложится в архитектуру.</p>

<p>Хорошая новость! С ECS вставить аналитику можно красиво! Не зря же я заговорил про модули.</p>

<p>Приведу пример из проекта на Entitas.</p>

<p>Во-первых, я решил отвязать системы геймплея от аналитики. Для этого создал отдельный датакласс для колбеков из геймплея.</p>

<pre>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">  <span class="k">public</span> <span class="k">class</span> <span class="nc">EntitasEvents</span>
  <span class="p">{</span>
    <span class="p">[</span><span class="n">CanBeNull</span><span class="p">]</span> <span class="k">public</span> <span class="n">Action</span> <span class="n">onLevelCleared</span><span class="p">;</span>
    <span class="p">[</span><span class="n">CanBeNull</span><span class="p">]</span> <span class="k">public</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">Vector3</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">onCharacterLocationHeartbeat</span><span class="p">;</span>
    <span class="p">[</span><span class="n">CanBeNull</span><span class="p">]</span> <span class="k">public</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">TutorialStep</span><span class="p">&gt;</span> <span class="n">onTutorialStepStarted</span><span class="p">;</span>
    <span class="p">[</span><span class="n">CanBeNull</span><span class="p">]</span> <span class="k">public</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">AbilityRef</span><span class="p">&gt;&gt;</span> <span class="n">onAbilitySelected</span><span class="p">;</span>
    <span class="p">[</span><span class="n">CanBeNull</span><span class="p">]</span> <span class="k">public</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">DamageDescriptor</span><span class="p">,</span> <span class="kt">float</span><span class="p">&gt;&gt;</span> <span class="n">onReportDamageStatistics</span><span class="p">;</span>
  <span class="p">}</span></code></pre></figure>

</pre>

<p>Это позволит отвязаться от конкретного интерфейса аналитики и предоставить API для подписки на конкретные события внутри геймплея.</p>

<p>Тогда изменения геймплея не будут затрагивать аналитику, и наоборот.</p>

<p>Сами системы аналитики создаются отдельно от игровых систем, по принципу модуля.</p>

<pre>
<figure class="highlight"><pre><code class="language-c#" data-lang="c#">    <span class="k">private</span> <span class="k">void</span> <span class="nf">CreateAnalyticsSystems</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">_events</span><span class="p">?.</span><span class="n">onLevelCleared</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">_coreSystems</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">LevelClearedAnalyticsSystem</span><span class="p">(</span><span class="n">_superContext</span><span class="p">,</span> <span class="n">_events</span><span class="p">.</span><span class="n">onLevelCleared</span><span class="p">));</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">_events</span><span class="p">?.</span><span class="n">onCharacterLocationHeartbeat</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">_coreSystems</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span>
          <span class="k">new</span> <span class="nf">CharacterLocationHeartbeatSystem</span><span class="p">(</span>
            <span class="n">_superContext</span><span class="p">.</span><span class="n">gameContext</span><span class="p">,</span>
            <span class="n">_uniqueEntity</span><span class="p">.</span><span class="n">serviceLocator</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">characterLocationHeartbeatInterval</span><span class="p">,</span>
            <span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">isAlive</span><span class="p">)</span> <span class="p">=&gt;</span>
              <span class="n">_events</span><span class="p">.</span><span class="n">onCharacterLocationHeartbeat</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">isAlive</span><span class="p">)</span>
          <span class="p">)</span>
        <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">_events</span><span class="p">?.</span><span class="n">onReportDamageStatistics</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">_coreSystems</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">DamageStatisticsSystem</span><span class="p">(</span><span class="n">_superContext</span><span class="p">,</span> <span class="n">_events</span><span class="p">.</span><span class="n">onReportDamageStatistics</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span></code></pre></figure>

</pre>

<p>Для примера, рассмотрим систему для сборки статистики урона от мобов.</p>

<pre>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#">    <span class="k">public</span> <span class="k">class</span> <span class="nc">DamageStatisticsSystem</span> <span class="p">:</span> <span class="n">IExecuteSystem</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">DamageDescriptor</span><span class="p">,</span> <span class="kt">float</span><span class="p">&gt;&gt;</span> <span class="n">_onReportDamageStatistics</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">SingletonEntity</span> <span class="n">_uniqueEntity</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IGroup</span><span class="p">&lt;</span><span class="n">EventsEntity</span><span class="p">&gt;</span> <span class="n">_damageEvents</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IGroup</span><span class="p">&lt;</span><span class="n">GameEntity</span><span class="p">&gt;</span> <span class="n">_activeCharacterGroup</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">DamageStatisticsSystem</span><span class="p">(</span>
            <span class="n">SuperContext</span> <span class="n">superContext</span><span class="p">,</span>
            <span class="p">[</span><span class="n">CanBeNull</span><span class="p">]</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">DamageDescriptor</span><span class="p">,</span> <span class="kt">float</span><span class="p">&gt;&gt;</span> <span class="n">onReportDamageStatistics</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_onReportDamageStatistics</span> <span class="p">=</span> <span class="n">onReportDamageStatistics</span><span class="p">;</span>
            <span class="n">_uniqueEntity</span> <span class="p">=</span> <span class="n">superContext</span><span class="p">.</span><span class="n">uniqueEntity</span><span class="p">;</span>
            <span class="n">_uniqueEntity</span><span class="p">.</span><span class="n">isDamageStatistics</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="n">_damageEvents</span> <span class="p">=</span> <span class="n">superContext</span><span class="p">.</span><span class="n">eventsContext</span><span class="p">.</span><span class="nf">GetGroup</span><span class="p">(</span><span class="n">EventsMatcher</span><span class="p">.</span><span class="n">DamageEvent</span><span class="p">);</span>
            <span class="n">_activeCharacterGroup</span> <span class="p">=</span> <span class="n">superContext</span><span class="p">.</span><span class="n">gameContext</span>
                    <span class="p">.</span><span class="nf">GetGroup</span><span class="p">(</span><span class="n">GameMatcher</span><span class="p">.</span><span class="nf">AllOf</span><span class="p">(</span><span class="n">GameMatcher</span><span class="p">.</span><span class="n">ActiveCharacter</span><span class="p">,</span> <span class="n">GameMatcher</span><span class="p">.</span><span class="n">Character</span><span class="p">));</span>
            <span class="n">_uniqueEntity</span><span class="p">.</span><span class="n">runData</span><span class="p">.</span><span class="n">runData</span><span class="p">.</span><span class="n">damageStatistics</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span> <span class="c1">// make sure each room has clean stats</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Execute</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">_uniqueEntity</span><span class="p">.</span><span class="n">isDamageStatistics</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">activeCharacterEntity</span> <span class="p">=</span> <span class="n">_activeCharacterGroup</span><span class="p">.</span><span class="nf">GetSingleEntity</span><span class="p">();</span>


            <span class="kt">var</span> <span class="n">statistics</span> <span class="p">=</span> <span class="n">_uniqueEntity</span><span class="p">.</span><span class="n">runData</span><span class="p">.</span><span class="n">runData</span><span class="p">.</span><span class="n">damageStatistics</span><span class="p">;</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">damageEvent</span> <span class="k">in</span> <span class="n">_damageEvents</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">isActiveCharacterDamage</span> <span class="p">=</span> <span class="n">damageEvent</span><span class="p">.</span><span class="n">damageEvent</span><span class="p">.</span><span class="n">targetId</span> <span class="p">==</span> <span class="n">activeCharacterEntity</span><span class="p">.</span><span class="n">character</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(!</span><span class="n">isActiveCharacterDamage</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

                <span class="kt">var</span> <span class="n">damageDescriptor</span> <span class="p">=</span> <span class="nf">GetDamageDescriptor</span><span class="p">(</span><span class="n">damageEvent</span><span class="p">.</span><span class="n">damageEvent</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">damage</span> <span class="p">=</span> <span class="n">statistics</span><span class="p">.</span><span class="nf">GetValueOrDefault</span><span class="p">(</span><span class="n">damageDescriptor</span><span class="p">,</span> <span class="m">0L</span><span class="p">);</span>
                <span class="n">statistics</span><span class="p">[</span><span class="n">damageDescriptor</span><span class="p">]</span> <span class="p">=</span> <span class="n">damage</span> <span class="p">+</span> <span class="n">damageEvent</span><span class="p">.</span><span class="n">damageEvent</span><span class="p">.</span><span class="n">damage</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(!</span><span class="n">_uniqueEntity</span><span class="p">.</span><span class="n">hasScenarioCompleted</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">activeCharacterEntity</span><span class="p">.</span><span class="n">isDead</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

            <span class="n">_onReportDamageStatistics</span><span class="p">?.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">_uniqueEntity</span><span class="p">.</span><span class="n">runData</span><span class="p">.</span><span class="n">runData</span><span class="p">.</span><span class="n">damageStatistics</span><span class="p">);</span>
            <span class="n">_uniqueEntity</span><span class="p">.</span><span class="n">isDamageStatistics</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">static</span> <span class="n">DamageDescriptor</span> <span class="nf">GetDamageDescriptor</span><span class="p">(</span><span class="n">DamageEventComponent</span> <span class="n">damageEventComponent</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="k">new</span> <span class="nf">DamageDescriptor</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="n">botAttack</span> <span class="p">=</span> <span class="n">damageEventComponent</span><span class="p">.</span><span class="n">botAttackRef</span><span class="p">,</span>
                <span class="n">botPrototype</span> <span class="p">=</span> <span class="n">damageEventComponent</span><span class="p">.</span><span class="n">botPrototypeRef</span><span class="p">,</span>
                <span class="n">damageZone</span> <span class="p">=</span> <span class="n">damageEventComponent</span><span class="p">.</span><span class="n">damageZoneRef</span>
            <span class="p">};</span>

    <span class="p">}</span></code></pre></figure>

</pre>

<p>Ключевое в этой системе, что она использует компоненты из других систем, такие как DamageEvent или ActiveCharacter, но никак не влияет на сами эти системы.</p>

<p>Просто делает свое дело, накапливая статистику в RunData – это контекст забега в игре.</p>

<p>А когда уровень завершен (опять же, логика завершения уровня лежит где-то в других системах), то дергает соответствующий колбек, отдавая данные вовне.</p>

<p>Итак, что же такого хорошего в таком подходе?</p>

<ol>
  <li>Аналитика разбита между отдельными системами. Каждая система делает только одну вещь и делает ее хорошо – Single responsibility principle</li>
  <li>Системы аналитики не имеют своего состояния. Они используют общедоступные данные в компонентах ECS. Другие системы ничего не знают об аналитике – Loose coupling</li>
  <li>Системы аналитики никак напрямую не привязаны к отправке этой самой аналитике. Т.е. условный транспорт может быть любой и может меняться независимо.</li>
  <li>Системы аналитики организованы в отдельный “модуль” и могут легко подключаться и отключаться</li>
</ol>

<h2 id="подводим-итоги">Подводим итоги</h2>

<p>Люди все еще думают классическими терминами ООП, и стремятся “унаследовать” все подряд. Для механики игр больше подходят другие решения вроде Entity Component System (ECS). И да, если вы не пробовали писать код с таким подходом, то скорее всего придется немножко сломать голову и поменять мышление.</p>

<h2 id="ссылки">Ссылки</h2>

<ul>
  <li><a href="https://github.com/junkdog/artemis-odb/wiki/Introduction-to-Entity-Systems">Introduction to Entity Systems</a></li>
  <li><a href="https://github.com/sschmid/Entitas-CSharp">Entitas: Entity Component System Framework specifically made for C# &amp; Unity</a></li>
  <li><a href="https://habr.com/post/343778/">Шаблон проектирования Entity-Component-System — реализация и пример игры</a></li>
  <li><a href="http://www.davidpol.com/2018/03/28/survival-shooter-ecs/">Survival Shooter using Unity’s Entity Component System</a></li>
</ul>]]></content><author><name>Ivan Fateev</name></author><category term="Gamedev" /><category term="Gamedev" /><category term="Architecture" /><category term="Patterns" /><summary type="html"><![CDATA[Использование паттерна “Компонент” – это единственная альтернатива не потеряться среди леса из деревьев наследования. Я поясню.]]></summary></entry></feed>